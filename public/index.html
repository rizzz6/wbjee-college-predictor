<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="/output.css" rel="stylesheet" onload="window.cssLoaded = true;">
    
    <!-- Critical CSS for dark mode - inline to ensure immediate loading -->
    <style>
        /* Critical dark mode styles that must load immediately */
        html.dark .dark\\:text-white { color: rgb(255 255 255) !important; }
        html.dark .dark\\:text-gray-100 { color: rgb(243 244 246) !important; }
        html.dark .dark\\:text-gray-200 { color: rgb(229 231 235) !important; }
        html.dark .dark\\:text-gray-300 { color: rgb(209 213 219) !important; }
        html.dark .dark\\:text-gray-400 { color: rgb(156 163 175) !important; }
        html.dark .dark\\:bg-gray-700 { background-color: rgb(55 65 81) !important; }
        html.dark .dark\\:bg-gray-800 { background-color: rgb(31 41 55) !important; }
        html.dark .dark\\:border-gray-600 { border-color: rgb(75 85 99) !important; }
        html.dark .dark\\:bg-white { background-color: rgb(31 41 55) !important; }
        html.dark .dark\\:bg-gray-50 { background-color: rgb(55 65 81) !important; }
        html.dark .dark\\:border-gray-200 { border-color: rgb(75 85 99) !important; }
        html.dark .dark\\:border-gray-300 { border-color: rgb(75 85 99) !important; }
        
        /* Ensure dark mode is applied immediately */
        html.dark body { background-color: rgb(24 26 27) !important; }
        html.dark [class*="bg-[#FFFCF2]"] { background-color: rgb(24 26 27) !important; }
        
        /* Fix rank distribution button styling */
        #rank-distribution-btn {
            background-color: rgb(229 231 235) !important;
            color: rgb(55 65 81) !important;
            background-image: none !important;
        }
        html.dark #rank-distribution-btn {
            background-color: rgb(55 65 81) !important;
            color: rgb(209 213 219) !important;
            background-image: none !important;
        }
        
        /* Override Tailwind's button reset for action buttons */
        .action-button {
            background-color: rgb(229 231 235) !important;
            color: rgb(55 65 81) !important;
            background-image: none !important;
        }
        html.dark .action-button {
            background-color: rgb(55 65 81) !important;
            color: rgb(209 213 219) !important;
            background-image: none !important;
        }
    </style>
    
    <title>WBJEE College Predictor 2025 - Free College Finder Tool | Jadavpur, Calcutta University</title>
    <meta name="title" content="WBJEE College Predictor 2025 - Free College Finder Tool | Jadavpur, Calcutta University">
    <meta name="description" content="Free WBJEE college predictor tool 2025. Find engineering colleges and branches in West Bengal based on your WBJEE rank. Get detailed analysis, cutoff trends, admission chances, and college comparison for Jadavpur University, Calcutta University, and other top engineering colleges. Instant results, mobile-friendly, and completely free to use.">
    <meta name="keywords" content="WBJEE 2025, WBJEE college finder, WBJEE rank predictor, WBJEE college predictor, WBJEE cutoff 2025, engineering colleges West Bengal, WBJEE admission, WBJEE rank calculator, WBJEE college list, WBJEE branch finder, Jadavpur University, Calcutta University, engineering admission West Bengal, WBJEE counseling, WBJEE rank analysis, WBJEE seat allotment, WBJEE merit list, engineering colleges Kolkata, WBJEE 2025 cutoff, WBJEE admission process">
    <meta name="author" content="rizzz6">
    <meta name="robots" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1">
    <meta name="language" content="English">
    <meta name="revisit-after" content="7 days">
    <meta name="geo.region" content="IN-WB">
    <meta name="geo.placename" content="West Bengal">
    <meta name="geo.position" content="22.9868;87.8550">
    <meta name="ICBM" content="22.9868, 87.8550">
    <meta name="distribution" content="global">
    <meta name="rating" content="general">
    <meta name="coverage" content="worldwide">
    
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://wbjee-college-predictor.vercel.app/">
    <meta property="og:title" content="WBJEE College Predictor 2025 - Free College Finder Tool | Jadavpur, Calcutta University">
    <meta property="og:description" content="Free WBJEE college predictor tool 2025. Find engineering colleges and branches in West Bengal based on your WBJEE rank. Get detailed analysis, cutoff trends, admission chances, and college comparison for Jadavpur University, Calcutta University, and other top engineering colleges.">
    <meta property="og:image" content="https://wbjee-college-predictor.vercel.app/og-image.png">
    <meta property="og:site_name" content="WBJEE College/Branch Finder">
    <meta property="og:locale" content="en_US">
    
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://wbjee-college-predictor.vercel.app/">
    <meta property="twitter:title" content="WBJEE College Predictor 2025 - Free College Finder Tool | Jadavpur, Calcutta University">
    <meta property="twitter:description" content="Free WBJEE college predictor tool 2025. Find engineering colleges and branches in West Bengal based on your WBJEE rank. Get detailed analysis, cutoff trends, admission chances, and college comparison for Jadavpur University, Calcutta University, and other top engineering colleges.">
    <meta property="twitter:image" content="https://wbjee-college-predictor.vercel.app/og-image.png">
    
    <meta name="theme-color" content="#53AC5D">
    <meta name="msapplication-TileColor" content="#53AC5D">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="WBJEE College Finder">
    <meta name="application-name" content="WBJEE College Finder">
    <meta name="msapplication-config" content="/browserconfig.xml">
    <meta name="format-detection" content="telephone=no">
    <meta name="mobile-web-app-capable" content="yes">
    
    <link rel="canonical" href="https://wbjee-college-predictor.vercel.app/">
    <link rel="sitemap" type="application/xml" title="Sitemap" href="/sitemap.xml">
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiBmaWxsPSIjNTNBQzVEIi8+Cjx0ZXh0IHg9IjE2IiB5PSIyMiIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE2IiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+V0I8L3RleHQ+Cjwvc3ZnPgo=">
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTgwIiBoZWlnaHQ9IjE4MCIgdmlld0JveD0iMCAwIDE4MCAxODAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxODAiIGhlaWdodD0iMTgwIiBmaWxsPSIjNTNBQzVEIi8+Cjx0ZXh0IHg9IjkwIiB5PSIxMDAiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSI0OCIgZmlsbD0id2hpdGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiPldCPC90ZXh0Pgo8L3N2Zz4K">
    <link rel="icon" type="image/svg+xml" sizes="32x32" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiBmaWxsPSIjNTNBQzVEIi8+Cjx0ZXh0IHg9IjE2IiB5PSIyMiIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE2IiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+V0I8L3RleHQ+Cjwvc3ZnPgo=">
    <link rel="icon" type="image/svg+xml" sizes="16x16" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHZpZXdCb3g9IjAgMCAxNiAxNiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjE2IiBoZWlnaHQ9IjE2IiBmaWxsPSIjNTNBQzVEIi8+Cjx0ZXh0IHg9IjgiIHk9IjEyIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTIiIGZpbGw9IndoaXRlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj5XQjwvdGV4dD4KPC9zdmc+Cg==">
    
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link rel="preconnect" href="https://rsms.me">
    <link rel="dns-prefetch" href="//wbjeeb.nic.in">
    <link rel="dns-prefetch" href="//www.reddit.com">
    <link rel="dns-prefetch" href="//www.google-analytics.com">
    <link rel="dns-prefetch" href="//www.googletagmanager.com">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <!-- Apply dark mode immediately to prevent flash -->
    <script>

        
        (function() {
            const savedTheme = localStorage.getItem('wbjeeTheme');
            if (savedTheme === 'dark') {
                document.documentElement.classList.add('dark');
            }
            
            function waitForCSS() {
                if (window.cssLoaded || document.readyState === 'complete') {
                    const isDark = document.documentElement.classList.contains('dark');
                    if (isDark && document.body) {
                        document.body.style.display = 'none';
                        document.body.offsetHeight; // Force reflow
                        document.body.style.display = '';
                    }
                } else {
                    setTimeout(waitForCSS, 10);
                }
            }
            

            
                    waitForCSS();
        })();
    </script>
    
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-Y5WXZ7Q4Q2"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-Y5WXZ7Q4Q2');
    </script>
    
    <!-- Structured Data for SEO -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "WBJEE College/Branch Finder",
      "description": "Free WBJEE college predictor tool 2025. Find engineering colleges and branches in West Bengal based on your WBJEE rank.",
      "url": "https://wbjee-college-predictor.vercel.app/",
      "applicationCategory": "EducationalApplication",
      "operatingSystem": "Web Browser",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "INR"
      },
      "author": {
        "@type": "Person",
        "name": "rizzz6"
      },
      "publisher": {
        "@type": "Organization",
        "name": "WBJEE College Finder"
      },
      "keywords": "WBJEE 2025, college predictor, engineering admission, West Bengal",
      "inLanguage": "en-US",
      "isAccessibleForFree": true
    }
    </script>
    
    <!-- Additional Structured Data -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Organization",
      "name": "WBJEE College Finder",
      "url": "https://wbjee-college-predictor.vercel.app/",
      "logo": "https://wbjee-college-predictor.vercel.app/favicon-32x32.png",
      "sameAs": [
        "https://www.reddit.com/r/wbjee/"
      ],
      "contactPoint": {
        "@type": "ContactPoint",
        "contactType": "customer service",
        "availableLanguage": "English"
      }
    }
    </script>
    
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "BreadcrumbList",
      "itemListElement": [
        {
          "@type": "ListItem",
          "position": 1,
          "name": "Home",
          "item": "https://wbjee-college-predictor.vercel.app/"
        },
        {
          "@type": "ListItem",
          "position": 2,
          "name": "WBJEE College Finder",
          "item": "https://wbjee-college-predictor.vercel.app/"
        }
      ]
    }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        th .sort-indicator {
            display: inline-block;
            margin-left: 5px;
            opacity: 0.5;
            width: 1em;
            transition: opacity 0.2s;
        }
        th.sorted-asc .sort-indicator,
        th.sorted-desc .sort-indicator {
            opacity: 1;
        }
        tbody tr:hover {
            background-color: #f3f4f6 !important;
        }
        .filter-panel, .modal {
            z-index: 50;
        }
        .filter-panel-body::-webkit-scrollbar, .modal-body::-webkit-scrollbar {
            width: 6px;
        }
        .filter-panel-body::-webkit-scrollbar-track, .modal-body::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        .filter-panel-body::-webkit-scrollbar-thumb, .modal-body::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }
        .filter-panel-body::-webkit-scrollbar-thumb:hover, .modal-body::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .loading-spinner {
            animation: spin 1s linear infinite;
        }
        
        /* improved loading animations */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        @keyframes slideIn {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .loading-pulse {
            animation: pulse 1.5s ease-in-out infinite;
        }
        .slide-in {
            animation: slideIn 0.3s ease-out;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        
        /* Performance optimizations for large tables */
        #table-body {
            contain: layout style paint;
        }
        
        #table-body tr {
            contain: layout style;
        }
        
        /* Optimize rendering for large datasets */
        .large-dataset {
            will-change: transform;
        }
        
        /* Reduce repaints during scrolling */
        .table-container {
            transform: translateZ(0);
            backface-visibility: hidden;
        }
        
        /* back to top button */
        .back-to-top {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        .back-to-top.visible {
            opacity: 1;
            visibility: visible;
        }
        
        /* dark mode styles */
        .dark {
            color-scheme: dark;
        }
        .dark body {
            background-color: #181a1b !important;
            color: #f3f4f6 !important;
        }
        .dark .bg-white {
            background-color: #23272a !important;
        }
        .dark .text-gray-800, .dark .text-gray-900 {
            color: #f3f4f6 !important;
        }
        .dark .text-gray-600 {
            color: #cbd5e1 !important;
        }
        .dark .text-gray-500 {
            color: #a0aec0 !important;
        }
        .dark .border-gray-200 {
            border-color: #2d3748 !important;
        }
        .dark .border-gray-300 {
            border-color: #4a5568 !important;
        }
        .dark .bg-gray-50, .dark .bg-gray-100, .dark .bg-gray-200 {
            background-color: #23272a !important;
        }
        .dark .hover\:bg-gray-300:hover {
            background-color: #2d3748 !important;
        }
        .dark .shadow-md, .dark .shadow-lg, .dark .shadow-xl {
            box-shadow: 0 4px 12px 0 rgba(0,0,0,0.7) !important;
        }
        .dark .bg-gradient-to-r.from-green-50.to-blue-50 {
            background: linear-gradient(to right, #23272a, #181a1b) !important;
        }
        .dark .border-green-100 {
            border-color: #2d4d2d !important;
        }
        .dark .bg-\[#FFFCF2\] {
            background-color: #181a1b !important;
        }
        
        /* Ensure table background adapts to dark mode */
        .dark #results-table {
            background-color: rgb(31 41 55) !important;
        }
        .dark #results-table thead {
            background-color: rgb(55 65 81) !important;
        }
        .dark #results-table tbody tr:hover {
            background-color: rgb(55 65 81) !important;
        }
        
        /* Force dark mode styles with higher specificity */
        html.dark .dark\\:text-white {
            color: rgb(255 255 255) !important;
        }
        html.dark .dark\\:text-gray-100 {
            color: rgb(243 244 246) !important;
        }
        html.dark .dark\\:text-gray-200 {
            color: rgb(229 231 235) !important;
        }
        html.dark .dark\\:text-gray-300 {
            color: rgb(209 213 219) !important;
        }
        html.dark .dark\\:text-gray-400 {
            color: rgb(156 163 175) !important;
        }
        html.dark .dark\\:bg-gray-700 {
            background-color: rgb(55 65 81) !important;
        }
        html.dark .dark\\:bg-gray-800 {
            background-color: rgb(31 41 55) !important;
        }
        html.dark .dark\\:border-gray-600 {
            border-color: rgb(75 85 99) !important;
        }
        

        
        /* Prevent text size changes */
        body, button, input, select, textarea {
            font-size: inherit;
            line-height: inherit;
        }
        .favorite-btn {
            cursor: pointer;
            background: none !important;
            border: none !important;
            padding: 8px;
            min-width: 44px;
            min-height: 44px;
            font-size: 1.5rem;
            line-height: 1;
            vertical-align: middle;
            box-shadow: none !important;
            transition: color 0.2s, transform 0.15s;
            text-shadow: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }
        .favorite-btn svg {
            width: 0.9em;
            height: 0.9em;
            display: block;
            pointer-events: none;
            transition: fill 0.2s, stroke 0.2s;
        }
        .favorite-btn:not(.favorited) svg {
            fill: none;
            stroke: #888888;
            stroke-width: 2.2;
        }
        .favorite-btn.favorited svg {
            fill: #ffc107;
            stroke: #ffc107;
            stroke-width: 2.2;
            filter: drop-shadow(0 0 4px #ffe066);
            transform: scale(1.15);
        }
        .favorite-btn:hover svg {
            stroke: #ffb300;
            filter: drop-shadow(0 0 6px #ffe066);
        }
        .dark .favorite-btn:not(.favorited) svg {
            stroke: #7dd3fc;
        }
        .dark .favorite-btn.favorited svg {
            fill: #ffc107;
            stroke: #ffc107;
            filter: drop-shadow(0 0 6px #ffe066);
        }

        #table-body tr {
            cursor: pointer;
        }
        .predictions-hidden #prediction-header,
        .predictions-hidden .prediction-cell {
            display: none;
        }
        .filter-option-hidden {
            display: none;
        }
        
        /* lazy loading styles */
        .lazy-row {
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
        }
        .lazy-row.loaded {
            opacity: 1;
            transform: translateY(0);
        }
        .lazy-loading {
            height: 60px;
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading-shimmer 1.5s infinite;
        }
        @keyframes loading-shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        /* Virtual scrolling styles */
        .virtual-scroll-container {
            position: relative;
            overflow-y: auto;
            height: 600px;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            background: white;
        }
        
        .dark .virtual-scroll-container {
            background: #1f2937;
            border-color: #374151;
        }
        
        .virtual-scroll-content {
            position: relative;
            width: 100%;
        }
        
        /* Virtual scroll table specific styles - completely separate from regular table */
        #results-table-virtual {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }
        
        #results-table-virtual thead {
            position: sticky;
            top: 0;
            z-index: 10;
            background: #f9fafb;
        }
        
        .dark #results-table-virtual thead {
            background: #374151;
        }
        
        #results-table-virtual thead th {
            padding: 12px 6px;
            text-align: left;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #6b7280;
            border-bottom: 2px solid #e5e7eb;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .dark #results-table-virtual thead th {
            color: #9ca3af;
            border-bottom-color: #4b5563;
        }
        
        #results-table-virtual tbody {
            background: white;
        }
        
        .dark #results-table-virtual tbody {
            background: #1f2937;
        }
        
        #results-table-virtual tbody tr {
            height: 60px;
            border-bottom: 1px solid #f3f4f6;
            transition: background-color 0.2s;
        }
        
        .dark #results-table-virtual tbody tr {
            border-bottom-color: #374151;
        }
        
        #results-table-virtual tbody tr:hover {
            background-color: #f9fafb;
        }
        
        .dark #results-table-virtual tbody tr:hover {
            background-color: #374151;
        }
        
        #results-table-virtual tbody td {
            padding: 12px 6px;
            vertical-align: middle;
            height: 60px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 0.875rem;
            color: #374151;
            border: none;
        }
        
        .dark #results-table-virtual tbody td {
            color: #f3f4f6;
        }
        
        /* Column widths for virtual scroll table */
        #results-table-virtual th:nth-child(1), #results-table-virtual td:nth-child(1) { width: 5%; }  /* Fav */
        #results-table-virtual th:nth-child(2), #results-table-virtual td:nth-child(2) { width: 10%; } /* Prediction */
        #results-table-virtual th:nth-child(3), #results-table-virtual td:nth-child(3) { width: 20%; } /* Institute */
        #results-table-virtual th:nth-child(4), #results-table-virtual td:nth-child(4) { width: 15%; } /* Branch */
        #results-table-virtual th:nth-child(5), #results-table-virtual td:nth-child(5) { width: 10%; } /* Category */
        #results-table-virtual th:nth-child(6), #results-table-virtual td:nth-child(6) { width: 10%; } /* Opening Rank */
        #results-table-virtual th:nth-child(7), #results-table-virtual td:nth-child(7) { width: 10%; } /* Closing Rank */
        #results-table-virtual th:nth-child(8), #results-table-virtual td:nth-child(8) { width: 8%; }  /* Year */
        #results-table-virtual th:nth-child(9), #results-table-virtual td:nth-child(9) { width: 8%; }  /* Round */
        #results-table-virtual th:nth-child(10), #results-table-virtual td:nth-child(10) { width: 7%; } /* Quota */
        #results-table-virtual th:nth-child(11), #results-table-virtual td:nth-child(11) { width: 7%; } /* Seat Type */
        
        /* Smooth scrolling for virtual scroll */
        .virtual-scroll-container {
            scroll-behavior: smooth;
        }
        
        /* Loading indicator for virtual scroll */
        .virtual-loading {
            text-align: center;
            padding: 20px;
            color: #6b7280;
        }
        
        /* Loading indicator for virtual scroll */
        .virtual-loading {
            text-align: center;
            padding: 20px;
            color: #6b7280;
        }
        #results-table thead th {
            position: sticky;
            top: 0;
            background: #f9fafb;
            z-index: 2;
        }
        
        .dark .filter-btn, .dark .filter-panel, .dark .filter-panel-body {
            background-color: #23272a !important;
            color: #f3f4f6 !important;
            border: 1px solid #2d3748 !important;
            box-shadow: 0 2px 8px 0 rgba(0,0,0,0.5) !important;
        }
        .dark .filter-btn-label {
            color: #e0e7ef !important;
        }
        .dark .filter-search {
            background-color: #181a1b !important;
            color: #f3f4f6 !important;
            border-color: #4a5568 !important;
        }
        .dark .filter-checkbox:checked {
            accent-color: #9ca3af !important;
        }
        .dark input, .dark select, .dark textarea {
            background-color: #23272a !important;
            color: #f3f4f6 !important;
            border: 1px solid #4a5568 !important;
            box-shadow: 0 1px 2px 0 rgba(0,0,0,0.3) !important;
        }
        .dark input:focus, .dark select:focus, .dark textarea:focus {
            border-color: #4a5568 !important;
            outline: none !important;
            box-shadow: none !important;
        }
        .dark .done-filter-btn, .dark .select-all-btn, .dark .clear-all-btn {
            background-color: #374151 !important;
            color: #f3f4f6 !important;
            border: 1px solid #4b5563 !important;
            box-shadow: none !important;
            transition: background 0.2s, color 0.2s;
        }
        .dark .done-filter-btn:hover, .dark .select-all-btn:hover, .dark .clear-all-btn:hover {
            background-color: #4b5563 !important;
            color: #fff !important;
        }
        .dark #rank {
            background-color: #23272a !important;
            color: #f3f4f6 !important;
            border: 1px solid #4a5568 !important;
            font-weight: 500;
        }
        .dark #legend-popover-btn {
            background-color: #23272a !important;
            color: #f3f4f6 !important;
            border: 1px solid #4a5568 !important;
        }

        .dark #results-table, .dark #results-table tr, .dark #results-table td, .dark #results-table th {
            background-color: #23272a !important;
            color: #f3f4f6 !important;
            border-color: #2d3748 !important;
        }
        .dark #results-table tr {
            box-shadow: 0 1px 4px 0 rgba(0,0,0,0.4) !important;
            border-radius: 0.5rem !important;
            margin-bottom: 0.5rem !important;
        }
        .dark #results-table tr:hover {
            background-color: #1e293b !important;
        }
        .dark .prediction-cell {
            font-weight: 600;
            letter-spacing: 0.01em;
        }
        .dark .rounded-md, .dark .rounded-lg {
            border-radius: 0.5rem !important;
        }

        /* Pagination info styling */
        #page-info {
            background: transparent;
            color: #64748b;
            font-size: 1rem;
            font-weight: 500;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            margin: 0 0.5rem;
            letter-spacing: 0.01em;
            box-shadow: none;
            display: inline-block;
        }
        .dark #page-info {
            color: #cbd5e1;
            background: transparent;
        }
        .dark .favorite-btn, .dark .favorite-btn.favorited {
          background: none !important;
          border: none !important;
          color: #fbbf24 !important;
          box-shadow: none !important;
          text-shadow: none !important;
        }
        .dark .favorite-btn.favorited {
          color: #ff9800 !important;
          text-shadow: 0 0 8px #fb923c, 0 0 2px #ffedd5;
          transform: scale(1.15);
        }
        .dark .favorite-btn:hover {
          color: #f59e42 !important;
          transform: scale(1.2) rotate(-8deg);
          text-shadow: 0 0 10px #ffedd5;
        }
        /* Accessibility: Darker table text in light mode */
        #results-table .text-gray-500 {
          color: #444 !important;
        }
        #results-table .text-gray-600 {
          color: #222 !important;
        }
        /* Add this to the <style> section (after other table styles): */
        .table-container {
          overflow-x: auto;
          width: 100%;
        }
        #results-table {
          min-width: 600px;
        }
        .dark #legend-popover-btn {
            background-color: #23272a !important;
            color: #f3f4f6 !important;
            border: 1px solid #4a5568 !important;
        }
        .dark .done-filter-btn:hover, .dark .select-all-btn:hover, .dark .clear-all-btn:hover {
            background-color: #4b5563 !important;
            color: #fff !important;
        }
        .dark #reset-button {
            background-color: #374151 !important;
            color: #f3f4f6 !important;
            border: 1px solid #4b5563 !important;
            box-shadow: none !important;
            transition: background 0.2s, color 0.2s;
        }
        .dark #reset-button:hover {
            background-color: #4b5563 !important;
            color: #fff !important;
        }
        .dark #toggle-faq-section {
            background-color: #374151 !important;
            color: #f3f4f6 !important;
            border: 1px solid #4b5563 !important;
        }
        .dark #toggle-faq-section:hover {
            background-color: #4b5563 !important;
            color: #fff !important;
        }
    </style>
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
    
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "WBJEE College/Branch Finder",
        "description": "Free WBJEE college predictor tool to find colleges and branches based on your WBJEE rank with detailed analysis and cutoff trends.",
        "url": "https://wbjee-college-predictor.vercel.app/",
        "applicationCategory": "EducationalApplication",
        "operatingSystem": "Web Browser",
        "offers": {
            "@type": "Offer",
            "price": "0",
            "priceCurrency": "INR"
        },
        "author": {
            "@type": "Person",
            "name": "rizzz6",
            "url": "https://www.reddit.com/user/rizzz6"
        },
        "creator": {
            "@type": "Person",
            "name": "rizzz6"
        },
        "keywords": "WBJEE, college finder, rank predictor, engineering colleges, West Bengal, admission, cutoff",
        "audience": {
            "@type": "Audience",
            "audienceType": "WBJEE aspirants and students"
        },
        "featureList": [
            "College prediction based on WBJEE rank",
            "Branch-wise cutoff analysis",
            "Historical trend analysis",
            "Filter by college, branch, category",
            "Export results to CSV",
            "Mobile responsive design"
        ]
    }
    </script>
    
    <!-- faq schema -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "FAQPage",
        "mainEntity": [
            {
                "@type": "Question",
                "name": "How to use WBJEE College Finder?",
                "acceptedAnswer": {
                    "@type": "Answer",
                    "text": "Enter your WBJEE rank in the input field and click search. The tool will show you colleges and branches where you have a good chance of admission based on historical cutoff data."
                }
            },
            {
                "@type": "Question",
                "name": "Is this WBJEE college predictor free?",
                "acceptedAnswer": {
                    "@type": "Answer",
                    "text": "Yes, this WBJEE college finder tool is completely free to use. No registration, payment, or subscription required. We believe in making college prediction accessible to all WBJEE aspirants."
                }
            },
            {
                "@type": "Question",
                "name": "How accurate is the WBJEE college prediction?",
                "acceptedAnswer": {
                    "@type": "Answer",
                    "text": "The predictions are based on historical WBJEE cutoff data from official sources. While we strive for accuracy, actual cutoffs may vary each year depending on factors like exam difficulty, number of applicants, and seat availability."
                }
            },
            {
                "@type": "Question",
                "name": "Which colleges are included in WBJEE College Finder?",
                "acceptedAnswer": {
                    "@type": "Answer",
                    "text": "The tool includes all engineering colleges in West Bengal that participate in WBJEE counseling, including government institutions like Jadavpur University, Calcutta University, and private engineering colleges across the state."
                }
            },
            {
                "@type": "Question",
                "name": "What is WBJEE 2025 cutoff trend analysis?",
                "acceptedAnswer": {
                    "@type": "Answer",
                    "text": "Our tool analyzes historical WBJEE cutoff data to predict trends for 2025. It shows whether cutoffs are increasing or decreasing for specific colleges and branches, helping you make informed decisions about your college choices."
                }
            },
            {
                "@type": "Question",
                "name": "How to check WBJEE rank for college admission?",
                "acceptedAnswer": {
                    "@type": "Answer",
                    "text": "Enter your WBJEE rank in our predictor tool to see which colleges and branches you can get admission to. The tool compares your rank with historical cutoff data and shows your admission chances for different options."
                }
            }
        ]
    }
    </script>
</head>
<body class="bg-[#FFFCF2] text-gray-800">

    <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-70 flex items-center justify-center z-50 hidden">
      <div class="flex flex-col items-center">
        <svg class="animate-spin h-10 w-10 text-blue-600 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path>
        </svg>
        <span class="text-blue-700 font-medium">Loading...</span>
        </div>
    </div>
    
    <div id="chart-modal" class="hidden modal fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-4 border-b border-gray-200">
                            <h3 id="chart-title" class="text-lg font-semibold text-gray-900 dark:text-white">Rank Trend</h3>
            <button id="close-chart-modal" class="text-gray-500 hover:text-gray-800 dark:text-gray-400 dark:hover:text-gray-200 text-2xl" aria-label="Close modal">&times;</button>
            </div>
            <div class="p-6 overflow-y-auto modal-body">
                <canvas id="rank-trend-chart"></canvas>
            </div>
        </div>
    </div>

    <div id="college-details-modal" class="hidden modal fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-4 border-b border-gray-200">
                            <h3 id="college-details-title" class="text-lg font-semibold text-gray-900 dark:text-white">College Details</h3>
            <button id="close-college-details-modal" class="text-gray-500 hover:text-gray-800 dark:text-gray-400 dark:hover:text-gray-200 text-2xl" aria-label="Close modal">&times;</button>
            </div>
            <div id="college-details-body" class="p-6 overflow-y-auto modal-body">
            </div>
        </div>
    </div>
    
    <div id="comparison-modal" class="hidden modal fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-6xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-4 border-b border-gray-200">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Shortlist Comparison</h3>
            <button id="close-comparison-modal" class="text-gray-500 hover:text-gray-800 dark:text-gray-400 dark:hover:text-gray-200 text-2xl" aria-label="Close modal">&times;</button>
            </div>
            <div id="comparison-body" class="p-6 overflow-y-auto modal-body grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            </div>
        </div>
    </div>


    <div class="container mx-auto p-4 md:p-8">
        <header class="relative text-center mb-8 bg-gradient-to-r from-green-50 to-blue-50 py-8 px-6 rounded-lg shadow-sm border border-green-100">
            <h1 class="text-3xl md:text-4xl font-bold" style="color: #FF4500;">WBJEE College/Branch Finder</h1>
            <p class="text-gray-600 dark:text-gray-300 mt-2 text-lg">Free WBJEE college predictor tool. Find your perfect engineering college and branch based on your WBJEE rank with detailed analysis and cutoff trends.</p>
            <div class="absolute top-4 right-4 flex items-center gap-2">
                <button id="dark-mode-toggle" class="w-8 h-8 bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 rounded-full flex items-center justify-center text-gray-600 hover:text-gray-800 dark:text-gray-300 dark:hover:text-gray-100 transition-colors" style="outline: none !important; box-shadow: none !important;" aria-label="Toggle dark mode" title="Toggle dark mode (Ctrl+Shift+D)">
                    <svg id="sun-icon" class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
                    </svg>
                    <svg id="moon-icon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                    </svg>
                </button>
                <button id="open-help-modal" class="w-8 h-8 bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 rounded-full flex items-center justify-center text-gray-600 hover:text-gray-800 dark:text-gray-300 dark:hover:text-gray-100 transition-colors" style="outline: none !important; box-shadow: none !important;" aria-label="Help">?</button>
            </div>
        </header>

        <section class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md mb-8">
            <div class="mb-4">
                <label for="rank" class="block text-lg font-semibold text-gray-800 dark:text-white mb-2">Your WBJEE Rank</label>
                <div class="flex flex-col sm:flex-row gap-2">
                    <input type="number" id="rank" placeholder="Enter your WBJEE rank (e.g., 1234)" min="1" class="w-full sm:w-auto sm:max-w-xs p-3 border border-gray-300 bg-white rounded-md shadow-sm text-gray-900 placeholder-gray-400 text-base" style="outline: none !important; box-shadow: none !important;" aria-describedby="rank-help">
                    <button id="search-button" class="w-full sm:w-auto px-5 py-2 text-sm font-medium text-white rounded-md shadow-sm hover:opacity-90 bg-[#4064BF]" style="outline: none !important; box-shadow: none !important;" aria-label="Search WBJEE colleges">Search Colleges</button>
            </div>
            <p id="rank-help" class="text-sm text-gray-600 dark:text-gray-300 mt-1">Enter your WBJEE rank to find colleges where you have a good chance of admission</p>
            </div>
            <h2 class="text-base font-semibold mb-2 text-gray-700 dark:text-gray-200">Filters</h2>
            <div class="flex flex-col sm:flex-row sm:flex-wrap gap-3 mb-6">
                <div id="institute-filter" class="relative filter-dropdown"></div>
                <div id="branch-filter" class="relative filter-dropdown"></div>
                <div id="category-filter" class="relative filter-dropdown"></div>
                <div id="year-filter" class="relative filter-dropdown"></div>
                <div id="round-filter" class="relative filter-dropdown"></div>
                <div id="quota-filter" class="relative filter-dropdown"></div>
                <div id="seat_type-filter" class="relative filter-dropdown"></div>
            </div>
            <div class="flex items-center flex-nowrap gap-4 mt-4">
                <div id="tiering-toggle-container" class="flex items-center gap-2">
                    <button id="tiering-btn" type="button" class="px-4 py-2 text-sm font-medium text-white rounded-md shadow-sm hover:opacity-90 bg-[#00c61c]" style="background-color: #00c61c !important; outline: none !important; box-shadow: none !important;">
                        <span id="tiering-btn-text">Show Predictions</span>
                    </button>
                    <button id="legend-popover-btn" class="sm:hidden flex items-center px-4 py-2 text-sm font-medium bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-md shadow-sm hover:bg-gray-300 dark:hover:bg-gray-600" style="outline: none !important; box-shadow: none !important;" aria-label="Show legend" type="button">
                        Legend
                    </button>
                </div>
                <div id="highlight-legend" class="hidden sm:flex flex-1 min-w-0 flex-nowrap items-center gap-x-3 text-sm overflow-x-auto pb-2">
                    <span class="font-semibold shrink-0 mr-1">Legend:</span>
                    <span class="px-3 py-1.5 rounded-lg border-2 font-semibold text-sm shadow-sm bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-100 border-green-300 dark:border-green-700 shrink-0">Confirm</span>
                    <span class="px-3 py-1.5 rounded-lg border-2 font-semibold text-sm shadow-sm bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-100 border-blue-300 dark:border-blue-700 shrink-0">Great</span>
                    <span class="px-3 py-1.5 rounded-lg border-2 font-semibold text-sm shadow-sm bg-cyan-100 dark:bg-cyan-900/30 text-cyan-800 dark:text-cyan-100 border-cyan-300 dark:border-cyan-700 shrink-0">Good</span>
                    <span class="px-3 py-1.5 rounded-lg border-2 font-semibold text-sm shadow-sm bg-amber-100 dark:bg-amber-900/30 text-amber-800 dark:text-amber-100 border-amber-300 dark:border-amber-700 shrink-0">Low</span>
                    <span class="px-3 py-1.5 rounded-lg border-2 font-semibold text-sm shadow-sm bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-100 border-red-300 dark:border-red-700 shrink-0">No Chance</span>
                </div>
            </div>
                <div id="legend-modal" class="sm:hidden fixed inset-0 z-50 bg-black bg-opacity-30 flex items-center justify-center hidden">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-11/12 max-w-xs relative">
                    <button id="close-legend-modal" class="absolute top-2 right-2 text-gray-400 hover:text-gray-700 dark:text-gray-300 dark:hover:text-gray-100 text-2xl" aria-label="Close legend">&times;</button>
                    <div class="flex flex-col gap-2 text-sm">
                        <span class="font-semibold mb-2">Legend:</span>
                        <span class="px-3 py-1.5 rounded-lg border-2 font-semibold text-sm shadow-sm bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-100 border-green-300 dark:border-green-700">Confirm</span>
                        <span class="px-3 py-1.5 rounded-lg border-2 font-semibold text-sm shadow-sm bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-100 border-blue-300 dark:border-blue-700">Great</span>
                        <span class="px-3 py-1.5 rounded-lg border-2 font-semibold text-sm shadow-sm bg-cyan-100 dark:bg-cyan-900/30 text-cyan-800 dark:text-cyan-100 border-cyan-300 dark:border-cyan-700">Good</span>
                        <span class="px-3 py-1.5 rounded-lg border-2 font-semibold text-sm shadow-sm bg-amber-100 dark:bg-amber-900/30 text-amber-800 dark:text-amber-100 border-amber-300 dark:border-amber-700">Low</span>
                        <span class="px-3 py-1.5 rounded-lg border-2 font-semibold text-sm shadow-sm bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-100 border-red-300 dark:border-red-700">No Chance</span>
                    </div>
                </div>
            </div>

            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 border-t border-gray-200 pt-6 mt-6">
                 <div class="flex items-center gap-4">
                    <button id="show-favorites-btn" class="px-5 py-2 text-sm font-medium text-white rounded-md shadow-sm hover:opacity-90 flex items-center gap-2 bg-[#00c61c]" style="background-color: #00c61c !important; outline: none !important; box-shadow: none !important;">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>
                        <span id="favorites-btn-text">Show Shortlist</span>
                        <span id="favorites-count-badge" class="ml-1 bg-yellow-300 text-yellow-900 text-xs font-bold px-2 py-0.5 rounded-full hidden"></span>
                    </button>
                    <button id="compare-favorites-btn" class="hidden px-5 py-2 text-sm font-medium text-white rounded-md shadow-sm hover:opacity-90 disabled:opacity-50 disabled:cursor-not-allowed bg-[#4064BF]" style="outline: none !important; box-shadow: none !important;" disabled>Compare Selected</button>
                </div>
                <div class="flex flex-wrap justify-end gap-4">
                    <button id="rank-distribution-btn" class="px-5 py-2 text-sm font-medium rounded-md shadow-sm transition-colors" style="outline: none !important; box-shadow: none !important; border: 1px solid transparent; background-color: rgb(229 231 235) !important; color: rgb(55 65 81) !important;">Rank Distribution</button>
                    <button id="virtual-scroll-toggle" class="px-5 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-gray-200 dark:bg-gray-700 rounded-md shadow-sm hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors" style="outline: none !important; box-shadow: none !important; border: 1px solid transparent;">Enable Virtual Scroll</button>
                    
                    <div class="relative">
                        <button id="export-share-dropdown-btn" class="action-button px-5 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-gray-200 dark:bg-gray-700 rounded-md shadow-sm hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors flex items-center gap-2" style="outline: none !important; box-shadow: none !important; border: 1px solid transparent;">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            Export & Share
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                        
                        <div id="export-share-dropdown" class="absolute right-0 mt-2 w-64 bg-white dark:bg-gray-800 rounded-md shadow-lg border border-gray-200 dark:border-gray-600 z-50 hidden">
                            <div class="py-1">
                                <div class="px-3 py-2 text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider border-b border-gray-200 dark:border-gray-600">Export Options</div>
                                <button id="export-results-csv" class="w-full text-left px-3 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center gap-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                    Export Results (CSV)
                                </button>
                                <button id="export-shortlist-csv" class="w-full text-left px-3 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center gap-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                    Export Shortlist (CSV)
                                </button>
                                <button id="export-results-pdf" class="w-full text-left px-3 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center gap-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                                    </svg>
                                    Export Results (PDF)
                                </button>
                                <button id="export-shortlist-pdf" class="w-full text-left px-3 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center gap-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                                    </svg>
                                    Export Shortlist (PDF)
                                </button>
                                
                                <div class="px-3 py-2 text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider border-b border-gray-200 dark:border-gray-600 mt-2">Share Options</div>
                                <button id="share-results" class="w-full text-left px-3 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center gap-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z"></path>
                                    </svg>
                                    Share Results
                                </button>
                                <button id="share-shortlist" class="w-full text-left px-3 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center gap-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z"></path>
                                    </svg>
                                    Share Shortlist
                                </button>
                                <button id="share-everything" class="w-full text-left px-3 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center gap-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z"></path>
                                    </svg>
                                    Share Everything
                                </button>
                                
                                <div class="px-3 py-2 text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider border-b border-gray-200 dark:border-gray-600 mt-2">Copy Options</div>
                                <button id="copy-results-text" class="w-full text-left px-3 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center gap-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                    </svg>
                                    Copy Results (Text)
                                </button>
                                <button id="copy-college-codes" class="w-full text-left px-3 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center gap-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                    </svg>
                                    Copy College Codes
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <button id="reset-button" class="action-button px-5 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-gray-200 dark:bg-gray-700 rounded-md shadow-sm hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors" style="outline: none !important; box-shadow: none !important; border: 1px solid transparent;">Reset</button>
                </div>
            </div>
        </section>

        <section class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
             <div class="flex flex-wrap items-center justify-between gap-4 mb-4">
                <h3 id="results-count" class="text-xl font-semibold text-gray-900 dark:text-white flex items-center gap-3">
                    <svg class="loading-spinner h-6 w-6 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    <span class="text-gray-900 dark:text-white">Loading data...</span>
                </h3>
                <div class="flex items-center gap-4">
                    <div class="flex items-center gap-2">
                        <label for="entries-per-page" class="text-sm font-medium text-gray-700 dark:text-gray-300">Show</label>
                        <select id="entries-per-page" class="bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md px-2 py-1 text-sm text-gray-900 dark:text-gray-300" style="outline: none !important; box-shadow: none !important;">
                            <option value="50" selected>50</option>
                            <option value="100">100</option>
                            <option value="200">200</option>
                            <option value="all">All</option>
                        </select>
                    </div>
                    <div id="pagination-nav" class="flex items-center gap-2">
                        <button id="prev-page" class="px-4 py-2 sm:px-3 sm:py-1 text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-50 dark:hover:bg-gray-600 active:bg-gray-100 dark:active:bg-gray-500 transition-colors">&lt; Prev</button>
                        <span id="page-info" class="text-sm text-gray-700 dark:text-gray-300 px-2"></span>
                        <button id="next-page" class="px-4 py-2 sm:px-3 sm:py-1 text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-50 dark:hover:bg-gray-600 active:bg-gray-100 dark:active:bg-gray-500 transition-colors">Next &gt;</button>
                    </div>
                </div>
            </div>
                <div class="table-container overflow-x-auto">
                <div id="virtual-scroll-container" class="virtual-scroll-container hidden">
                    <div id="virtual-scroll-content" class="virtual-scroll-content">
                        <table id="results-table-virtual" class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50 dark:bg-gray-800 sticky top-0 z-10">
                                <tr>
                                    <th id="fav-header-virtual" class="px-2 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Fav</th>
                                    <th id="prediction-header-virtual" data-column="prediction" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider cursor-pointer">Prediction <span class="sort-indicator"></span></th>
                                    <th data-column="institute" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider cursor-pointer">Institute <span class="sort-indicator"></span></th>
                                    <th data-column="branch" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider cursor-pointer">Branch <span class="sort-indicator"></span></th>
                                    <th data-column="category" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider cursor-pointer">Category <span class="sort-indicator"></span></th>
                                    <th data-column="opening_rank" data-type="number" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider cursor-pointer">Opening Rank <span class="sort-indicator"></span></th>
                                    <th data-column="closing_rank" data-type="number" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider cursor-pointer">Closing Rank <span class="sort-indicator"></span></th>
                                    <th data-column="year" data-type="number" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider cursor-pointer">Year <span class="sort-indicator"></span></th>
                                    <th data-column="round" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider cursor-pointer">Round <span class="sort-indicator"></span></th>
                                    <th data-column="quota" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider cursor-pointer">Quota <span class="sort-indicator"></span></th>
                                    <th data-column="seat_type" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider cursor-pointer">Seat Type <span class="sort-indicator"></span></th>
                                </tr>
                            </thead>
                            <tbody id="virtual-scroll-body" class="bg-white dark:bg-gray-900 divide-y divide-gray-200 dark:divide-gray-700">
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <table id="results-table" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                                            <th id="fav-header" class="px-2 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Fav</th>
                <th id="prediction-header" data-column="prediction" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider cursor-pointer">Prediction <span class="sort-indicator"></span></th>
                <th data-column="institute" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider cursor-pointer">Institute <span class="sort-indicator"></span></th>
                <th data-column="branch" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider cursor-pointer">Branch <span class="sort-indicator"></span></th>
                <th data-column="category" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider cursor-pointer">Category <span class="sort-indicator"></span></th>
                <th data-column="opening_rank" data-type="number" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider cursor-pointer">Opening Rank <span class="sort-indicator"></span></th>
                <th data-column="closing_rank" data-type="number" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider cursor-pointer">Closing Rank <span class="sort-indicator"></span></th>
                <th data-column="year" data-type="number" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider cursor-pointer">Year <span class="sort-indicator"></span></th>
                <th data-column="round" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider cursor-pointer">Round <span class="sort-indicator"></span></th>
                <th data-column="quota" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider cursor-pointer">Quota <span class="sort-indicator"></span></th>
                <th data-column="seat_type" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider cursor-pointer">Seat Type <span class="sort-indicator"></span></th>
                        </tr>
                    </thead>
                    <tbody id="table-body" class="bg-white divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </section>
    </div>

    <div id="input-error-modal" class="fixed inset-0 z-50 bg-black bg-opacity-30 flex items-center justify-center hidden">
  <div class="bg-white rounded-lg shadow-xl p-6 w-11/12 max-w-xs relative text-center">
    <div class="mb-4">
      <span class="text-red-600 text-2xl font-bold">!</span>
    </div>
                <div id="input-error-message" class="text-gray-800 dark:text-gray-200 text-base mb-6">Please enter your WBJEE rank.</div>
    <button id="close-input-error-modal" class="px-5 py-2 text-sm font-medium text-white rounded-md bg-[#4064BF] hover:opacity-90" style="outline: none !important; box-shadow: none !important;">OK</button>
  </div>
    </div>

    <div id="general-modal" class="fixed inset-0 z-50 bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-md mx-4 shadow-xl transform transition-all duration-300 scale-95 opacity-0" id="modal-content">
            <div class="flex items-center justify-between mb-4">
                <h3 id="modal-title" class="text-lg font-semibold text-gray-900 dark:text-white"> Information</h3>
                <button id="close-general-modal" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div id="modal-message" class="text-gray-700 dark:text-gray-300 mb-4"></div>
            <div class="flex justify-end">
                <button id="modal-ok-btn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700" style="outline: none !important; box-shadow: none !important;">
                    OK
                </button>
            </div>
        </div>
    </div>

    <div id="help-modal" class="fixed inset-0 z-50 bg-black bg-opacity-30 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 w-11/12 max-w-2xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-4 border-b border-gray-200">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Help & Guide</h3>
            <button id="close-help-modal" class="text-gray-500 hover:text-gray-800 dark:text-gray-400 dark:hover:text-gray-200 text-2xl" aria-label="Close modal">&times;</button>
            </div>
            <div class="p-6 overflow-y-auto">
                <div class="space-y-6">
                    <div>
                        <h4 class="font-semibold text-lg mb-2 text-gray-900 dark:text-white">How to Use</h4>
                        <ol class="list-decimal list-inside space-y-2 text-sm text-gray-700 dark:text-gray-300">
                            <li>Enter your WBJEE rank in the input field</li>
                            <li>Click "Search" to find matching colleges</li>
                            <li>Use filters to narrow down results</li>
                            <li>Click the star () to add colleges to your shortlist</li>
                            <li>Click on any row to view rank trends</li>
                            <li>Click on college names to see detailed information</li>

                        </ol>
                    </div>
                    <div>
                        <h4 class="font-semibold text-lg mb-2 text-gray-900 dark:text-white">Relevant Options Filtering</h4>
                        <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-3 mb-4">
                            <p class="text-sm text-blue-700 dark:text-blue-300">The filters automatically show only relevant options within 1.5x of your rank. This means if you enter rank 1000, you'll see colleges with closing ranks up to 1500, making your search more focused and practical.</p>
                        </div>
                    </div>
                    <div>
                        <h4 class="font-semibold text-lg mb-2 text-gray-900 dark:text-white">Predictions</h4>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm">
                            <div class="flex items-center gap-2">
                                <span class="px-2 py-1 rounded-md bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-100 border border-green-300 dark:border-green-700 text-xs font-semibold">Confirm</span>
                                <span class="text-gray-700 dark:text-gray-300"><strong>Confirm:</strong> Your rank is better than opening rank</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="px-2 py-1 rounded-md bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-100 border border-blue-300 dark:border-blue-700 text-xs font-semibold">Great</span>
                                <span class="text-gray-700 dark:text-gray-300"><strong>Great:</strong> 75% of closing rank</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="px-2 py-1 rounded-md bg-cyan-100 dark:bg-cyan-900/30 text-cyan-800 dark:text-cyan-100 border border-cyan-300 dark:border-cyan-700 text-xs font-semibold">Good</span>
                                <span class="text-gray-700 dark:text-gray-300"><strong>Good:</strong> 95% of closing rank</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="px-2 py-1 rounded-md bg-amber-100 dark:bg-amber-900/30 text-amber-800 dark:text-amber-100 border border-amber-300 dark:border-amber-700 text-xs font-semibold">Low</span>
                                <span class="text-gray-700 dark:text-gray-300"><strong>Low:</strong> 125% of closing rank</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="px-2 py-1 rounded-md bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-100 border border-red-300 dark:border-red-700 text-xs font-semibold">No Chance</span>
                                <span class="text-gray-700 dark:text-gray-300"><strong>No Chance:</strong> Beyond 125% of closing rank</span>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h4 class="font-semibold text-lg mb-2 text-gray-900 dark:text-white">Pro Tips</h4>
                        <div class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-700 rounded-lg p-4">
                            <p class="text-sm text-yellow-800 dark:text-yellow-200 mb-3"><strong> Recommended Sorting:</strong></p>
                            <ul class="text-sm text-yellow-700 dark:text-yellow-300 space-y-1">
                                <li> <strong>Sort by Prediction</strong> (No Chance  Confirm) to see your best chances first</li>
                                <li> <strong>Use filters</strong> to focus on specific colleges, branches, or categories</li>
                                <li> <strong>Add promising colleges</strong> to your shortlist for easy comparison</li>
                                <li> <strong>Check rank trends</strong> by clicking on any row to see historical data</li>

                            </ul>
                </div>
            </div>
                    <div class="mt-6">
                      <h4 class="text-base font-semibold mb-2 text-gray-800 dark:text-gray-200">Sharing Your Results</h4>
                      <ul class="list-disc pl-6 text-gray-700 dark:text-gray-300 text-sm space-y-1">
                        <li><b>Share Results</b>: Copies a link to your current search (rank + filters) so you can share your results with others. Does not include your shortlist.</li>
                        <li><b>Share Everything</b>: Copies the full page link, including your current search, filters, and shortlist (if visible), so others see exactly what you see.</li>
                      </ul>
                    </div>

                    <div class="mt-6">
                      <h4 class="text-base font-semibold mb-2 text-gray-800 dark:text-gray-200">Keyboard Shortcuts</h4>
                      <ul class="list-disc pl-6 text-gray-700 dark:text-gray-300 text-sm space-y-1">
                        <li><b>Ctrl/Cmd + Shift + D</b>: Toggle dark/light theme</li>
                        <li><b>Ctrl/Cmd + K</b>: Focus on rank input field</li>
                        <li><b>Ctrl/Cmd + F</b>: Show/hide favorites shortlist</li>
                        <li><b>Enter</b>: Search colleges (when rank input is focused)</li>
                        <li><b>Escape</b>: Close any open modal</li>
                      </ul>
                    </div>
                    <div>
                        <h4 class="font-semibold text-lg mb-2 text-gray-900 dark:text-white">Smart Dynamic Filtering</h4>
                        <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-3 mb-4">
                            <p class="text-sm text-blue-700 dark:text-blue-300">Our intelligent filtering adapts smoothly to your rank. Top ranks (1-100) get wider ranges (up to 3x), mid ranks (100-3000) get moderate ranges (1.5-2.2x), and higher ranks get focused ranges (minimum 1.5x). This provides personalized, realistic options without sudden jumps.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="college-details-modal" class="fixed inset-0 z-50 bg-black bg-opacity-30 flex items-center justify-center hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-11/12 max-w-4xl max-h-[90vh] flex flex-col slide-in">
            <div class="flex justify-between items-center p-4 border-b border-gray-200 dark:border-gray-700">
                <h3 id="college-details-title" class="text-lg font-semibold text-gray-900 dark:text-white">College Details</h3>
                <button id="close-college-details-modal" class="text-gray-500 hover:text-gray-800 dark:text-gray-400 dark:hover:text-white text-2xl transition-colors" aria-label="Close modal">&times;</button>
            </div>
            <div id="college-details-body" class="p-6 overflow-y-auto">
            </div>
        </div>
    </div>

    <div id="rank-distribution-modal" class="fixed inset-0 z-50 bg-black bg-opacity-30 flex items-center justify-center hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-11/12 max-w-4xl max-h-[90vh] flex flex-col slide-in">
            <div class="flex justify-between items-center p-4 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Rank Distribution</h3>
                <button id="close-rank-distribution-modal" class="text-gray-500 hover:text-gray-800 dark:text-gray-400 dark:hover:text-white text-2xl transition-colors" aria-label="Close modal">&times;</button>
            </div>
            <div class="p-6 overflow-y-auto">
                <div class="mb-4">
                    <p class="text-sm text-gray-600 dark:text-gray-300 mb-2">This chart shows the distribution of closing ranks in your current results. Your rank is highlighted to help you understand your position.</p>
                    <div id="user-rank-indicator" class="inline-block px-3 py-1 bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-200 rounded-md text-sm font-medium"></div>
                </div>
                <div class="chart-container" style="position: relative; height: 400px;">
                    <canvas id="rank-distribution-chart"></canvas>
                </div>
            </div>
        </div>
    </div>



    <div id="json-error-overlay" class="fixed inset-0 z-50 bg-black bg-opacity-30 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 w-11/12 max-w-md relative text-center slide-in">
            <div class="mb-4">
                <span class="text-red-600 text-4xl"></span>
            </div>
            <div class="text-gray-800 dark:text-gray-200 text-base mb-6">
                <p class="font-semibold mb-2 text-lg">Unable to Load Data</p>
                <p class="text-sm text-gray-600 dark:text-gray-300 mb-4">We couldn't load the college database. This might be due to:</p>
                <ul class="text-sm text-gray-600 dark:text-gray-300 text-left space-y-1 mb-4">
                    <li> Internet connection issues</li>
                    <li> Server temporarily unavailable</li>
                    <li> Data file not found</li>
                </ul>
                <p class="text-sm text-gray-600 dark:text-gray-300">Please try again in a few moments.</p>
            </div>
            <div class="flex gap-3 justify-center">
                <button id="retry-load-btn" class="px-5 py-2 text-sm font-medium text-white rounded-md bg-[#4064BF] hover:opacity-90" style="outline: none !important; box-shadow: none !important;"> Retry</button>
                <button onclick="location.reload()" class="px-5 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300" style="outline: none !important; box-shadow: none !important;"> Reload Page</button>
            </div>
        </div>
    </div>

    <script>
        
        
        function initializeApp() {
            initDarkMode();
            
                    if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('/sw.js')
                        .then((registration) => {
                            console.log('SW registered: ', registration);
                        })
                        .catch((registrationError) => {
                            console.log('SW registration failed: ', registrationError);
                        });
                });
            }
            
                    function initDarkMode() {
                const savedTheme = localStorage.getItem('wbjeeTheme') || 'light';
                if (savedTheme === 'dark') {
                    document.documentElement.classList.add('dark');
                }
                
                const darkModeToggle = document.getElementById('dark-mode-toggle');
                const sunIcon = document.getElementById('sun-icon');
                const moonIcon = document.getElementById('moon-icon');
                
                            if (darkModeToggle && sunIcon && moonIcon) {
                    if (savedTheme === 'dark') {
                        sunIcon.classList.remove('hidden');
                        moonIcon.classList.add('hidden');
                    }
                }
                
                darkModeToggle.addEventListener('click', () => {
                    const isDark = document.documentElement.classList.toggle('dark');
                    localStorage.setItem('wbjeeTheme', isDark ? 'dark' : 'light');
                    
                    if (isDark) {
                        sunIcon.classList.remove('hidden');
                        moonIcon.classList.add('hidden');
                    } else {
                        sunIcon.classList.add('hidden');
                        moonIcon.classList.remove('hidden');
                    }
                    
                    forceThemeUpdate();
                });
            }
            
            function forceThemeUpdate() {
                document.body.offsetHeight;
                
                updateAllDynamicElements();
            }
            
            function updateAllDynamicElements() {
                const isDark = document.documentElement.classList.contains('dark');
                
                            const resultsCountSpan = document.querySelector('#results-count span');
                if (resultsCountSpan) {
                    const currentText = resultsCountSpan.textContent;
                    if (currentText && currentText !== 'Loading data...') {
                        resultsCountSpan.innerHTML = `<span class="text-gray-900 dark:text-white">${currentText}</span>`;
                    }
                }
                
                const pageInfoSpan = document.getElementById('page-info');
                if (pageInfoSpan && pageInfoSpan.textContent) {
                    const currentText = pageInfoSpan.textContent;
                    pageInfoSpan.innerHTML = `<span class="text-gray-700 dark:text-gray-300">${currentText}</span>`;
                }
                
                document.querySelectorAll('.filter-btn-label').forEach(label => {
                    const currentText = label.textContent;
                    if (currentText) {
                        label.innerHTML = `<span class="text-gray-700 dark:text-gray-300">${currentText}</span>`;
                    }
                });
                
                const buttons = [
                    { id: 'show-favorites-btn', selector: '.btn-text', defaultText: 'Show Shortlist' },
                    { id: 'tiering-btn', selector: '#tiering-btn-text', defaultText: 'Show Predictions' },
                    
                    { id: 'search-button', selector: null, defaultText: 'Search' },
                    { id: 'compare-favorites-btn', selector: null, defaultText: 'Compare Selected' }
                ];
                
                buttons.forEach(button => {
                    const element = document.getElementById(button.id);
                    if (element) {
                        const textElement = button.selector ? element.querySelector(button.selector) : element;
                        if (textElement) {
                            const currentText = textElement.textContent || button.defaultText;
                            if (button.id === 'tiering-btn') {
                                textElement.innerHTML = `<span style="color: white !important;">${currentText}</span>`;
                            } else if (button.id === 'search-button' || button.id === 'show-favorites-btn' || button.id === 'compare-favorites-btn') {
                                textElement.innerHTML = `<span class="text-white">${currentText}</span>`;
                            } else {
                                textElement.innerHTML = `<span class="text-gray-700 dark:text-gray-300">${currentText}</span>`;
                            }
                        }
                    }
                });
                
                document.querySelectorAll('#table-body td').forEach(td => {
                    if (td.classList.contains('text-gray-500') && !td.classList.contains('dark:text-gray-400')) {
                        td.classList.add('dark:text-gray-400');
                    }
                });
                
                document.querySelectorAll('.prediction-badge').forEach(badge => {
                    const text = badge.textContent;
                    if (text) {
                        const badgeClasses = {
                            'Confirm': 'bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-100 border-green-300 dark:border-green-700',
                            'Great': 'bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-100 border-blue-300 dark:border-blue-700',
                            'Good': 'bg-cyan-100 dark:bg-cyan-900/30 text-cyan-800 dark:text-cyan-100 border-cyan-300 dark:border-cyan-700',
                            'Low': 'bg-amber-100 dark:bg-amber-900/30 text-amber-800 dark:text-amber-100 border-amber-300 dark:border-amber-700',
                            'No Chance': 'bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-100 border-red-300 dark:border-red-700'
                        };
                        const badgeClass = badgeClasses[text] || 'bg-gray-100 dark:bg-gray-900/30 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-700';
                        badge.className = `prediction-badge px-2 py-1 rounded-md text-xs font-semibold border ${badgeClass}`;
                    }
                });
            }
            
            function setupThemeObserver() {
                const observer = new MutationObserver((mutations) => {
                    mutations.forEach((mutation) => {
                        if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                            if (mutation.target === document.documentElement) {
                                                            setTimeout(() => {
                                    updateAllDynamicElements();
                                }, 10);
                            }
                        }
                        
                        if (mutation.type === 'childList') {
                                                    mutation.addedNodes.forEach((node) => {
                                if (node.nodeType === Node.ELEMENT_NODE) {
                                    applyThemeToElement(node);
                                }
                            });
                        }
                    });
                });
                
                observer.observe(document.documentElement, {
                    attributes: true,
                    attributeFilter: ['class']
                });
                
                observer.observe(document.body, {
                    childList: true,
                    subtree: true
                });
            }
            
            function applyThemeToElement(element) {
                const isDark = document.documentElement.classList.contains('dark');
                
                if (element.classList.contains('text-gray-500') && !element.classList.contains('dark:text-gray-400')) {
                    element.classList.add('dark:text-gray-400');
                }
                
                element.querySelectorAll('.text-gray-500').forEach(el => {
                    if (!el.classList.contains('dark:text-gray-400')) {
                        el.classList.add('dark:text-gray-400');
                    }
                });
                
                element.querySelectorAll('.prediction-badge').forEach(badge => {
                    const text = badge.textContent;
                    if (text) {
                        const badgeClasses = {
                            'Confirm': 'bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-100 border-green-300 dark:border-green-700',
                            'Great': 'bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-100 border-blue-300 dark:border-blue-700',
                            'Good': 'bg-cyan-100 dark:bg-cyan-900/30 text-cyan-800 dark:text-cyan-100 border-cyan-300 dark:border-cyan-700',
                            'Low': 'bg-amber-100 dark:bg-amber-900/30 text-amber-800 dark:text-amber-100 border-amber-300 dark:border-amber-700',
                            'No Chance': 'bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-100 border-red-300 dark:border-red-700'
                        };
                        const badgeClass = badgeClasses[text] || 'bg-gray-100 dark:bg-gray-900/30 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-700';
                        badge.className = `prediction-badge px-2 py-1 rounded-md text-xs font-semibold border ${badgeClass}`;
                    }
                });
            }
            
            if (typeof Chart === 'undefined') {
                console.warn('Chart.js not loaded. Charts will be disabled.');
            }

            document.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && document.activeElement === rankInput) {
                    e.preventDefault();
                    const searchBtn = document.getElementById('search-button');
                    if (searchBtn && !searchBtn.disabled) {
                        searchBtn.click();
                    }
                }
                
                if (e.key === 'Tab' && document.activeElement.classList.contains('table-row')) {
                    const rows = document.querySelectorAll('#table-body tr');
                    const currentIndex = Array.from(rows).indexOf(document.activeElement);
                    const nextRow = rows[currentIndex + 1];
                    if (nextRow) {
                        e.preventDefault();
                        nextRow.focus();
                    }
                }
                
                if (e.key === 'Escape') {
                    const modals = document.querySelectorAll('.modal:not(.hidden)');
                    if (modals.length > 0) {
                        const lastModal = modals[modals.length - 1];
                        const closeBtn = lastModal.querySelector('button[aria-label*="Close"], button[aria-label*="close"]');
                        if (closeBtn) closeBtn.click();
                    }
                }
                
                if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                    e.preventDefault();
                    const rankInput = document.getElementById('rank');
                    if (rankInput) rankInput.focus();
                }
                
                if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
                    e.preventDefault();
                    const favBtn = document.getElementById('show-favorites-btn');
                    if (favBtn) favBtn.click();
                }
                
                if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'D') {
                    e.preventDefault();
                    const darkModeToggle = document.getElementById('dark-mode-toggle');
                    if (darkModeToggle) darkModeToggle.click();
                }
            });

            const CONFIG = {
                JSON_FILE_PATH: '/api/data', // Changed to API endpoint
                PREDICTIONS: [
                    { name: 'Confirm',   threshold: 0.5,  color: 'text-green-500', class: 'rank-confirm' },
                    { name: 'Great',     threshold: 0.75, color: 'text-blue-500',  class: 'rank-great' },
                    { name: 'Good',      threshold: 1.0,  color: 'text-cyan-500',  class: 'rank-good' },
                    { name: 'Low',       threshold: 1.25, color: 'text-amber-500', class: 'rank-low' },
                    { name: 'No Chance', threshold: Infinity, color: 'text-red-500',   class: 'rank-no' }
                ],
                COMPARISON_MIN: 2,
                COMPARISON_MAX: 4,
            };

            const filterKeys = ['institute', 'branch', 'category', 'year', 'round', 'quota', 'seat_type'];
            
            let allData = [];
            let filteredData = [];
            let favorites = new Set();
            let isShowingFavorites = false;
            let isTieringEnabled = true;
            let sortState = { column: null, direction: 'none', type: 'string' };
            let currentPage = 1;
            let entriesPerPage = 50;
            
            let isVirtualScrollEnabled = false;
            let virtualScrollData = [];
            let virtualScrollConfig = {
                itemHeight: 60,
                visibleItems: 10,
                buffer: 5
            };

            let activeFilters = {};
            const initializeFilters = () => {
                activeFilters = { rank: '' };
                filterKeys.forEach(key => activeFilters[key] = []);
            };

            const rankInput = document.getElementById('rank');
            const tableBody = document.getElementById('table-body');
            const resultsCount = document.getElementById('results-count');
            const tableHeaders = document.querySelectorAll('#results-table th');
            const favHeader = document.getElementById('fav-header');
            const searchButton = document.getElementById('search-button');
            const resetButton = document.getElementById('reset-button');
            
            const entriesPerPageSelect = document.getElementById('entries-per-page');
            const prevPageButton = document.getElementById('prev-page');
            const nextPageButton = document.getElementById('next-page');
            const pageInfoSpan = document.getElementById('page-info');
            const paginationNav = document.getElementById('pagination-nav');
            const loadingOverlay = document.getElementById('loading-overlay');
            const showFavoritesBtn = document.getElementById('show-favorites-btn');
            const favoritesBtnText = document.getElementById('favorites-btn-text');
            const favoritesCountBadge = document.getElementById('favorites-count-badge');
            const compareFavoritesBtn = document.getElementById('compare-favorites-btn');
            const highlightLegend = document.getElementById('highlight-legend');
            const tieringBtn = document.getElementById('tiering-btn');
            const chartModal = document.getElementById('chart-modal');
            const closeChartModalBtn = document.getElementById('close-chart-modal');
            const chartTitle = document.getElementById('chart-title');
            const collegeDetailsModal = document.getElementById('college-details-modal');
            const closeCollegeDetailsModalBtn = document.getElementById('close-college-details-modal');
            const collegeDetailsTitle = document.getElementById('college-details-title');
            const collegeDetailsBody = document.getElementById('college-details-body');
            const comparisonModal = document.getElementById('comparison-modal');
            const closeComparisonModalBtn = document.getElementById('close-comparison-modal');
            const comparisonBody = document.getElementById('comparison-body');
            let rankTrendChart = null;
            let comparisonCharts = [];

            function addTableEventListeners() {
                document.querySelectorAll('.favorite-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const id = btn.dataset.id;
                        if (favorites.has(id)) favorites.delete(id);
                        else favorites.add(id);
                        saveFavorites();
                        if(isShowingFavorites) {
                            applyFiltersAndRender(false);
                        } else {
                            btn.classList.toggle('favorited', favorites.has(id));
                        }
                    });
                });

                document.querySelectorAll('.institute-link').forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        const institute = e.target.dataset.institute;
                        showCollegeDetails(institute);
                    });
                });
            }

            // ID and Base64 Filter State System
            const filterIdMaps = {};
            const filterValueMaps = {};
            filterKeys.forEach(key => {
                filterIdMaps[key] = new Map();
                filterValueMaps[key] = new Map();
            });

            function generateShortId(str, idx) {
                let hash = 0;
                for (let i = 0; i < str.length; i++) hash = ((hash << 5) - hash) + str.charCodeAt(i);
                return (Math.abs(hash) + idx).toString(36);
            }

            function buildFilterIdMaps(data) {
                filterKeys.forEach(key => {
                    const uniqueValues = Array.from(new Set(data.map(item => String(item[key])))).filter(v => v && v !== 'null');
                    uniqueValues.forEach((val, idx) => {
                        const id = generateShortId(key + ':' + val, idx);
                        filterIdMaps[key].set(val, id);
                        filterValueMaps[key].set(id, val);
                    });
                });
            }

            function encodeFiltersToBase64() {
                const obj = { rank: activeFilters.rank };
                filterKeys.forEach(key => {
                    obj[key] = activeFilters[key].map(val => filterIdMaps[key].get(val)).filter(Boolean);
                });
                return btoa(unescape(encodeURIComponent(JSON.stringify(obj))));
            }

            function decodeFiltersFromBase64(b64) {
                try {
                    const obj = JSON.parse(decodeURIComponent(escape(atob(b64))));
                    const filters = { rank: obj.rank || '' };
                    filterKeys.forEach(key => {
                        filters[key] = (obj[key] || []).map(id => filterValueMaps[key].get(id)).filter(Boolean);
                    });
                    return filters;
                } catch {
                    return null;
                }
            }
            // END ID and Base64 Filter State System

            function setControlsDisabled(disabled) {
                const controls = [
                    rankInput, searchButton, resetButton, shareEverythingButton, 
                    entriesPerPageSelect, prevPageButton, nextPageButton,
                    showFavoritesBtn, compareFavoritesBtn, tieringBtn
                ];
                controls.forEach(control => {
                    if (control) control.disabled = disabled;
                });
            }

            async function initializeApp() {
                try {
                    initializeFilters();
                    loadSettings();
                    updateFavoritesUI();
                    
                    let rawData = null;
                    const cachedData = localStorage.getItem('wbjeeData');
                    const cacheTimestamp = localStorage.getItem('wbjeeDataTimestamp');
                    const cacheAge = Date.now() - (parseInt(cacheTimestamp) || 0);
                    const cacheValid = cacheAge < 24 * 60 * 60 * 1000;
                    
                    if (cachedData && cacheValid) {
                        try {
                            rawData = JSON.parse(cachedData);
                            console.log('Loaded data from cache');
                        } catch (e) {
                            console.log('Cache corrupted, fetching fresh data');
                        }
                    }
                    
                    if (!rawData) {
                        let retries = 3;
                        let lastError;
                        
                        while (retries > 0) {
                            try {
                    const response = await fetch(CONFIG.JSON_FILE_PATH);
                                if (!response.ok) {
                                    const errorMessage = response.status === 404 ? 
                                        'Data file not found. Please check if the server is running correctly.' :
                                        response.status === 500 ? 
                                        'Server error. Please try again later.' :
                                        `Network error (${response.status}). Please check your internet connection.`;
                                    throw new Error(errorMessage);
                                }
                                rawData = await response.json();
                                break;
                            } catch (error) {
                                lastError = error;
                                retries--;
                                if (retries > 0) {
                                    await new Promise(resolve => setTimeout(resolve, 1000));
                                }
                            }
                        }
                        
                        if (!rawData) {
                            throw lastError;
                        }
                        
                        localStorage.setItem('wbjeeData', JSON.stringify(rawData));
                        localStorage.setItem('wbjeeDataTimestamp', Date.now().toString());
                        console.log('Cached fresh data');
                    }
                    
                    const getStr = (val) => (val != null ? String(val).trim() : null);
                    const getRank = (val) => {
                        const parsed = parseInt(val, 10);
                        return isNaN(parsed) ? null : parsed;
                    };

                    allData = rawData.map((item) => ({
                        id: `${getStr(item["Institute"])}-${getStr(item["Program"])}-${getStr(item["Category"])}-${getStr(item["Round"])}-${getRank(item["Year"])}-${getStr(item["Quota"])}-${getStr(item["Seat Type"])}`,
                        round: getStr(item["Round"]),
                        institute: getStr(item["Institute"]),
                        branch: getStr(item["Program"]),
                        seat_type: getStr(item["Seat Type"]),
                        quota: getStr(item["Quota"]),
                        category: getStr(item["Category"]),
                        opening_rank: getRank(item["Opening Rank"]),
                        closing_rank: getRank(item["Closing Rank"]),
                        year: getRank(item["Year"]),
                        prediction: { text: '-', order: CONFIG.PREDICTIONS.length + 1 }
                    }));
                    
                    buildFilterIdMaps(allData);
                    const allValidIds = new Set(allData.map(item => item.id));
                    favorites = new Set([...favorites].filter(id => allValidIds.has(id)));
                    saveFavorites();

                    createFilterDropdowns();
                    addEventListeners();
                    loadFiltersFromURL(); 
                    applyFiltersAndRender(true);
                    
                    updateFavoritesUI();
                    
                    initBackToTop();
                    
                    initModalSystem();
                    
                    setTimeout(() => {
                        forceThemeUpdate();
                    }, 100);
                    
                    setTimeout(() => {
                        if (window.cssLoaded) {
                            const isDark = document.documentElement.classList.contains('dark');
                            if (isDark && document.body) {
                                document.body.style.display = 'none';
                                document.body.offsetHeight; // Force reflow
                                document.body.style.display = '';
                            }
                        }
                    }, 200);
                    
                    setupThemeObserver();
                } catch (error) {
                    console.error('Initialization Error:', error);
                    const jsonErrorOverlay = document.getElementById('json-error-overlay');
                    if (jsonErrorOverlay) {
                        jsonErrorOverlay.classList.remove('hidden');
                        setControlsDisabled(true);
                    } else {
                        resultsCount.innerHTML = `<span class="text-red-600"> Error loading data</span>`;
                        tableBody.innerHTML = `<tr class="bg-red-50"><td colspan="11" class="px-6 py-12 text-center">
                            <div class="text-red-700 font-semibold mb-2"> Unable to load college data</div>
                            <div class="text-red-600 text-sm">${error.message}</div>
                            <button onclick="location.reload()" class="mt-4 px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">Retry</button>
                        </td></tr>`;
                    }
                }
            }
            
            function loadSettings() {
                try {
                const storedFavorites = JSON.parse(localStorage.getItem('wbjeeFavorites') || '[]');
                favorites = new Set(storedFavorites);
                    
                    if (allData && allData.length > 0) {
                        const validIds = new Set(allData.map(item => item.id));
                        const invalidFavorites = Array.from(favorites).filter(id => !validIds.has(id));
                        
                        if (invalidFavorites.length > 0) {
                            console.warn('Removing invalid favorites:', invalidFavorites);
                            invalidFavorites.forEach(id => favorites.delete(id));
                            saveFavorites();
                        }
                    }
                } catch (error) {
                    console.error('Error loading favorites:', error);
                    favorites = new Set();
                }
                
                const storedTiering = localStorage.getItem('wbjeeTieringEnabled');
                isTieringEnabled = storedTiering === null ? true : storedTiering === 'true';
                updateTieringButtonUI();
            }

            function updateFilterState(key, value, isChecked) {
                if (key === 'rank') {
                    activeFilters.rank = value;
                    return;
                }
                if (isChecked) {
                    if (!activeFilters[key].includes(value)) {
                        activeFilters[key].push(value);
                    }
                } else {
                    activeFilters[key] = activeFilters[key].filter(v => v !== value);
                }
            }
            
            function applyFiltersAndRender(isInitialLoad = false) {
                if (!isInitialLoad) loadingOverlay.classList.remove('hidden'); 

                setTimeout(() => {
                    try {
                        if (!Array.isArray(allData) || allData.length === 0) {
                            throw new Error('No data available. Please refresh the page.');
                        }
                    if (isShowingFavorites) {
                        filteredData = allData.filter(item => favorites.has(item.id));
                    } else {
                        const userRank = parseInt(activeFilters.rank, 10);
                        
                        // Smooth dynamic multiplier: eliminates cliff effects
                        // Formula: max(1.5, 3 - (log10(rank) * 0.425))
                        const getDynamicMultiplier = (rank) => {
                            if (rank <= 0) return 1.5;
                            const logRank = Math.log10(rank);
                            const multiplier = 3 - (logRank * 0.425);
                            return Math.max(1.5, multiplier);
                        };
                        
                        const multiplier = getDynamicMultiplier(userRank);
                        const maxDisplayRank = Math.round(userRank * multiplier);

                        filteredData = allData.filter(item => {
                            // Filter by rank range: show colleges where user has a realistic chance
                            // User can get into colleges where closing_rank is between user_rank and maxDisplayRank
                            if (item.closing_rank === null || 
                                item.closing_rank < userRank || 
                                item.closing_rank > maxDisplayRank) {
                                return false;
                            }
                            
                            // Apply other filters
                            for (const key of filterKeys) {
                                if (activeFilters[key].length > 0 && !activeFilters[key].includes(String(item[key]))) {
                                    return false;
                                }
                            }
                            return true;
                        });
                    }
                    
                    const userRank = parseInt(activeFilters.rank, 10);
                    calculatePredictions(filteredData, userRank);
                    
                    currentPage = 1;
                    if (!isShowingFavorites) {
                        updateURLWithFilters();
                        localStorage.setItem('wbjeeFilters', JSON.stringify(activeFilters));
                    }
                    updateFilterButtonLabels();
                    applySorting();
                    renderTable();
                    } catch (error) {
                        console.error('Error applying filters and rendering:', error);
                        resultsCount.innerHTML = `<span>Error applying filters.</span>`;
                        tableBody.innerHTML = `<tr class="bg-red-100"><td colspan="11" class="px-6 py-12 text-center text-red-700 font-semibold">${error.message}</td></tr>`;
                    }
                    if (!isInitialLoad) loadingOverlay.classList.add('hidden'); 
                }, 10);
            }
            
            function updateHeaderStyles() {
                tableHeaders.forEach(header => {
                    header.classList.remove('sorted-asc', 'sorted-desc', 'bg-gray-200');
                    const indicator = header.querySelector('.sort-indicator');
                    if (!indicator) return;
                    
                    if (header.dataset.column === sortState.column) {
                        header.classList.add('bg-gray-200');
                        if (sortState.direction === 'asc') {
                            header.classList.add('sorted-asc');
                            indicator.textContent = '';
                        } else if (sortState.direction === 'desc') {
                            header.classList.add('sorted-desc');
                            indicator.textContent = '';
                        } else {
                            indicator.textContent = '';
                        }
                    } else {
                        indicator.textContent = '';
                    }
                });
            }
            
            function applySorting() {
                const { column, direction } = sortState;
                if (direction === 'none' || column === null) {
                    updateHeaderStyles();
                    return;
                }

                filteredData.sort((a, b) => {
                    if (column === 'prediction') {
                        const userRank = parseInt(activeFilters.rank, 10);
                        
                        if (isNaN(userRank)) {
                        const comparison = (a.prediction.order || 99) - (b.prediction.order || 99);
                            return direction === 'asc' ? comparison : -comparison;
                        }
                        
                        const getPredictionScore = (item) => {
                            const { opening_rank, closing_rank } = item;
                            
                            if (opening_rank === null || closing_rank === null || 
                                isNaN(opening_rank) || isNaN(closing_rank) || 
                                opening_rank < 0 || closing_rank < 0) {
                                return -999999;
                            }
                            
                            if (opening_rank > closing_rank) {
                                return -999999;
                            }
                            
                            let score = item.prediction.order * 1000000;
                            
                            score += (100000 - closing_rank) * 100;
                            
                            const rankRange = closing_rank - opening_rank;
                            if (rankRange > 0) {
                                score += (10000 - rankRange) * 10;
                            }
                            
                            return score;
                        };
                        
                        const scoreA = getPredictionScore(a);
                        const scoreB = getPredictionScore(b);
                        const comparison = scoreA - scoreB;
                        
                        return direction === 'asc' ? comparison : -comparison;
                    }
                    
                    const valA = a[column]; 
                    const valB = b[column];
                    let comparison = 0;
                    if (sortState.type === 'number') {
                        comparison = (valA || Infinity) - (valB || Infinity);
                    } else {
                        comparison = String(valA || '').localeCompare(String(valB || ''));
                    }
                    return direction === 'asc' ? comparison : -comparison;
                });
                updateHeaderStyles();
            }
            
            function calculatePredictions(data, userRank) {
                if (isNaN(userRank)) {
                    data.forEach(item => {
                        item.prediction = { text: '-', order: 99 };
                    });
                    return;
                }

                data.forEach(item => {
                    const { opening_rank, closing_rank } = item;
                    let prediction = { text: '-', order: 99 }; 

                    if (opening_rank !== null && closing_rank !== null) {
                        // Calculate percentage thresholds
                        const threshold75 = closing_rank * 0.75;
                        const threshold95 = closing_rank * 0.95;
                        const threshold125 = closing_rank * 1.25;

                        // Apply tiering logic
                        if (userRank < opening_rank) {
                            prediction = { text: 'Confirm', order: 1, color: 'text-green-500', class: 'rank-confirm' };
                        } else if (userRank < threshold75) {
                            prediction = { text: 'Great', order: 2, color: 'text-blue-500', class: 'rank-great' };
                        } else if (userRank < threshold95) {
                            prediction = { text: 'Good', order: 3, color: 'text-cyan-500', class: 'rank-good' };
                        } else if (userRank < threshold125) {
                            prediction = { text: 'Low', order: 4, color: 'text-amber-500', class: 'rank-low' };
                        } else {
                            prediction = { text: 'No Chance', order: 5, color: 'text-red-500', class: 'rank-no' };
                        }
                    }
                    item.prediction = prediction;
                });
            }

            function createFilterDropdowns() {
                const uniqueValues = {};
                filterKeys.forEach(key => uniqueValues[key] = new Set());
                
                allData.forEach(item => {
                    filterKeys.forEach(key => {
                        if (item[key] != null) uniqueValues[key].add(item[key]);
                    });
                });

                filterKeys.forEach(key => {
                    const container = document.getElementById(`${key}-filter`);
                    if (!container) return;
                    const title = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    
                    const isNumeric = key === 'year';
                    const sortedOptions = Array.from(uniqueValues[key]).sort(isNumeric ? (a, b) => b - a : (a, b) => String(a).localeCompare(String(b)));
                    
                    let panelContent = sortedOptions.map((value, index) => {
                        const safeValue = String(value).replace(/\s+/g, '-').toLowerCase();
                        const id = `${key}-${safeValue}-${index}`;
                        return `
                        <label for="${id}" class="flex items-center space-x-2 p-2 rounded-md hover:bg-gray-100 cursor-pointer group">
                            <input type="checkbox" id="${id}" data-filter-key="${key}" value="${value}" class="filter-checkbox h-4 w-4 rounded border-gray-300 bg-gray-100 text-blue-600" style="outline: none !important; box-shadow: none !important;">
                            <span class="text-sm text-gray-700 dark:text-gray-300 group-hover:text-gray-900 dark:group-hover:text-gray-100">${value}</span>
                        </label>
                    `}).join('');
                    
                    container.innerHTML = `
                        <button id="${key}-filter-btn" class="filter-btn relative flex items-center justify-between w-full sm:w-48 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm px-4 py-3 sm:py-2 text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-600 active:bg-gray-100 dark:active:bg-gray-500 transition-colors" style="outline: none !important; box-shadow: none !important;">
                            <span class="filter-btn-label truncate pr-10">${title} (All)</span>
                            <span class="absolute right-2 top-1/2 -translate-y-1/2 flex items-center">
                                <span data-key="${key}" class="clear-single-filter hidden text-gray-400 hover:text-gray-800 text-lg mr-1">&times;</span>
                                <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                            </span>
                        </button>
                        <div id="${key}-filter-panel" class="filter-panel hidden absolute mt-2 w-72 sm:w-72 w-[calc(100vw-2rem)] max-w-sm bg-white dark:bg-gray-800 rounded-md shadow-lg border border-gray-200 dark:border-gray-600 z-50">
                            <div class="p-2 border-b border-gray-200">
                                <input type="search" id="${key}-search" name="${key}-search" placeholder="Search..." class="filter-search w-full p-2 text-sm border border-gray-300 bg-white rounded-md text-gray-900 placeholder-gray-400" style="outline: none !important; box-shadow: none !important;">
                            </div>
                            <div class="p-2 flex justify-between border-b border-gray-200 dark:border-gray-600">
                                <button class="select-all-btn text-xs sm:text-xs text-sm py-2 px-3 text-blue-600 hover:underline hover:bg-blue-50 dark:hover:bg-blue-900/20 rounded transition-colors">Select All Visible</button>
                                <button class="clear-all-btn text-xs sm:text-xs text-sm py-2 px-3 text-blue-600 hover:underline hover:bg-blue-50 dark:hover:bg-blue-900/20 rounded transition-colors">Clear Visible</button>
                            </div>
                            <div class="filter-panel-body p-2 max-h-60 sm:max-h-60 max-h-48 overflow-y-auto">${panelContent}</div>
                            <div class="p-2 border-t border-gray-200 dark:border-gray-600 flex justify-end">
                                <button class="done-filter-btn px-4 py-2 sm:py-1 text-sm font-medium bg-blue-600 text-white rounded hover:bg-blue-700 active:bg-blue-800 transition-colors" style="outline: none !important; box-shadow: none !important;" aria-label="Done filtering">Done</button>
                            </div>
                        </div>
                    `;
                });

                setTimeout(() => {
                  document.querySelectorAll('.filter-search').forEach(input => {
                    let searchTimeout;
                    input.addEventListener('input', function() {
                      clearTimeout(searchTimeout);
                      searchTimeout = setTimeout(() => {
                        const searchValue = this.value.trim().toLowerCase();
                        const panelBody = this.closest('.filter-panel').querySelector('.filter-panel-body');
                        panelBody.querySelectorAll('label').forEach(label => {
                          const text = label.textContent.trim().toLowerCase();
                          label.style.display = text.includes(searchValue) ? '' : 'none';
                        });
                      }, 150);
                    });
                  });

                  document.querySelectorAll('.filter-panel').forEach(panel => {
                    let startY = 0;
                    let currentY = 0;
                    
                    panel.addEventListener('touchstart', (e) => {
                      startY = e.touches[0].clientY;
                    }, { passive: true });
                    
                    panel.addEventListener('touchmove', (e) => {
                      currentY = e.touches[0].clientY;
                      const diff = startY - currentY;
                      
                      if (diff < -50) {
                        panel.classList.add('hidden');
                        const filterBtn = document.querySelector(`#${panel.id.replace('-filter-panel', '')}-filter-btn`);
                        if (filterBtn) {
                          filterBtn.classList.remove('ring-2', 'ring-blue-500');
                        }
                      }
                    }, { passive: true });
                  });
                }, 0);
            }

            function renderTable() {
                tableBody.innerHTML = ''; 
                
                if (isVirtualScrollEnabled) {
                    virtualScrollData = [...filteredData];
                    handleVirtualScroll();
                }
                
                const totalItems = filteredData.length;
                const totalPages = entriesPerPage === 'all' ? 1 : Math.ceil(totalItems / entriesPerPage);
                if (currentPage > totalPages) currentPage = totalPages || 1;

                const startIndex = entriesPerPage === 'all' ? 0 : (currentPage - 1) * entriesPerPage;
                const endIndex = entriesPerPage === 'all' ? totalItems : startIndex + entriesPerPage;
                const paginatedData = filteredData.slice(startIndex, endIndex);

                const resultsCountSpan = resultsCount.querySelector('span');
                const loadingSpinner = resultsCount.querySelector('.loading-spinner');
                if (loadingSpinner) loadingSpinner.classList.add('hidden');
                
                if (isShowingFavorites) {
                    favHeader.innerHTML = 'Actions';
                } else {
                    favHeader.innerHTML = 'Fav';
                }

                if (paginatedData.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="11" class="text-center text-gray-500 dark:text-gray-400 py-8">No colleges match your criteria. Try adjusting your filters.</td></tr>';
                } else {
                    const fragment = document.createDocumentFragment();
                    
                    const renderRowsOptimized = (data) => {
                        if (entriesPerPage === 'all' && data.length > 1000) {
                            tableBody.innerHTML = '<tr><td colspan="11" class="text-center text-gray-500 dark:text-gray-400 py-4">Loading large dataset... Please wait.</td></tr>';
                            
                            setTimeout(() => {
                                const fragment = document.createDocumentFragment();
                                const batchSize = 100;
                                let processed = 0;
                                
                                const processBatch = () => {
                                    const endIndex = Math.min(processed + batchSize, data.length);
                                    
                                    for (let i = processed; i < endIndex; i++) {
                                        const item = data[i];
                        const row = document.createElement('tr');
                                        
                        const isFavorited = favorites.has(item.id);
                        const identifier = { institute: item.institute, branch: item.branch, category: item.category, quota: item.quota, seat_type: item.seat_type };
                        row.dataset.identifier = JSON.stringify(identifier);
                        
                                                        if (isTieringEnabled && item.prediction.class) {
                                }
                        
                        const favAriaLabel = isFavorited ? `Remove ${item.institute} - ${item.branch} from shortlist` : `Add ${item.institute} - ${item.branch} to shortlist`;
                        
                        let favCell;
                        if (isShowingFavorites) {
                            favCell = `
                                <td class="px-4 py-3 align-middle text-center">
                                    <div class="flex items-center justify-center gap-x-4">
                                        <button type="button" class="favorite-btn favorited" data-id="${item.id}" aria-label="${favAriaLabel}" title="Remove from shortlist"></button>
                                                        <input type="checkbox" id="compare-${item.id}" class="compare-checkbox h-4 w-4 rounded border-gray-300 bg-gray-100 text-blue-600" data-id="${item.id}" title="Select for comparison" style="outline: none !important; box-shadow: none !important;">
                                    </div>
                                </td>`;
                        } else {
                                    favCell = `<td class="px-4 py-3 align-middle text-center"><button type="button" class="favorite-btn${isFavorited ? ' favorited' : ''}" data-id="${item.id}" aria-label="${favAriaLabel}" title="${isFavorited ? 'Remove from shortlist' : 'Add to shortlist'}"><svg viewBox='0 0 24 24'><polygon points='12,17.27 18.18,21 16.54,13.97 22,9.24 14.81,8.63 12,2 9.19,8.63 2,9.24 7.46,13.97 5.82,21'/></svg></button></td>`;
                        }
                        
                        row.innerHTML = `
                            ${favCell}
                                            <td class="prediction-cell px-6 py-4 align-middle whitespace-nowrap text-sm" aria-label="Prediction: ${item.prediction.text}">${getPredictionBadge(item.prediction)}</td>
                                            <td class="px-6 py-4 align-middle whitespace-nowrap text-sm"><span class="institute-link text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 hover:underline" data-institute="${item.institute}" role="button" tabindex="0" aria-label="View details for ${item.institute}">${item.institute || 'N/A'}</span></td>
                                            <td class="px-6 py-4 align-middle whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${item.branch || 'N/A'}</td>
                                            <td class="px-6 py-4 align-middle whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${item.category || 'N/A'}</td>
                                            <td class="px-6 py-4 align-middle whitespace-nowrap text-sm text-gray-500 dark:text-gray-400 font-mono">${item.opening_rank ?? 'N/A'}</td>
                                            <td class="px-6 py-4 align-middle whitespace-nowrap text-sm text-gray-500 dark:text-gray-400 font-mono">${item.closing_rank ?? 'N/A'}</td>
                                            <td class="px-6 py-4 align-middle whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${item.year ?? 'N/A'}</td>
                                            <td class="px-6 py-4 align-middle whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${item.round || 'N/A'}</td>
                                            <td class="px-6 py-4 align-middle whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${item.quota || 'N/A'}</td>
                                            <td class="px-6 py-4 align-middle whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${item.seat_type || 'N/A'}</td>
                                        `;
                                        fragment.appendChild(row);
                                    }
                                    
                                    processed = endIndex;
                                    
                                    if (processed % 1000 === 0) {
                                        const progressText = `Loading... ${processed.toLocaleString()} of ${data.length.toLocaleString()} records`;
                                        if (tableBody.querySelector('tr td')) {
                                            tableBody.querySelector('tr td').textContent = progressText;
                                        }
                                    }
                                    
                                    if (processed < data.length) {
                                        if (window.requestIdleCallback) {
                                            requestIdleCallback(processBatch, { timeout: 50 });
                                        } else {
                                            setTimeout(processBatch, 10);
                                        }
                                    } else {
                                        tableBody.innerHTML = '';
                                        tableBody.appendChild(fragment);
                                        
                                        setTimeout(() => {
                                            addTableEventListeners();
                                        }, 0);
                                    }
                                };
                                
                                processBatch();
                            }, 100);
                        } else {
                            const fragment = document.createDocumentFragment();
                            
                            data.forEach((item) => {
                                const row = document.createElement('tr');
                                
                                const isFavorited = favorites.has(item.id);
                                const identifier = { institute: item.institute, branch: item.branch, category: item.category, quota: item.quota, seat_type: item.seat_type };
                                row.dataset.identifier = JSON.stringify(identifier);
                                
                                if (isTieringEnabled && item.prediction.class) {
                                }
                                
                                const favAriaLabel = isFavorited ? `Remove ${item.institute} - ${item.branch} from shortlist` : `Add ${item.institute} - ${item.branch} to shortlist`;
                                
                                let favCell;
                                if (isShowingFavorites) {
                                    favCell = `
                                        <td class="px-4 py-3 align-middle text-center">
                                            <div class="flex items-center justify-center gap-x-4">
                                                <button type="button" class="favorite-btn favorited" data-id="${item.id}" aria-label="${favAriaLabel}" title="Remove from shortlist"></button>
                                                <input type="checkbox" id="compare-${item.id}" class="compare-checkbox h-4 w-4 rounded border-gray-300 bg-gray-100 text-blue-600" data-id="${item.id}" title="Select for comparison" style="outline: none !important; box-shadow: none !important;">
                                            </div>
                                        </td>`;
                                } else {
                                    favCell = `<td class="px-4 py-3 align-middle text-center"><button type="button" class="favorite-btn${isFavorited ? ' favorited' : ''}" data-id="${item.id}" aria-label="${favAriaLabel}" title="${isFavorited ? 'Remove from shortlist' : 'Add to shortlist'}"><svg viewBox='0 0 24 24'><polygon points='12,17.27 18.18,21 16.54,13.97 22,9.24 14.81,8.63 12,2 9.19,8.63 2,9.24 7.46,13.97 5.82,21'/></svg></button></td>`;
                                }
                                
                                row.innerHTML = `
                                    ${favCell}
                                    <td class="prediction-cell px-6 py-4 align-middle whitespace-nowrap text-sm">${getPredictionBadge(item.prediction)}</td>
                                    <td class="px-6 py-4 align-middle whitespace-nowrap text-sm"><span class="institute-link text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 hover:underline" data-institute="${item.institute}">${item.institute || 'N/A'}</span></td>
                                                                                <td class="px-6 py-4 align-middle whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${item.branch || 'N/A'}</td>
                                            <td class="px-6 py-4 align-middle whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${item.category || 'N/A'}</td>
                                            <td class="px-6 py-4 align-middle whitespace-nowrap text-sm text-gray-500 dark:text-gray-400 font-mono">${item.opening_rank ?? 'N/A'}</td>
                                            <td class="px-6 py-4 align-middle whitespace-nowrap text-sm text-gray-500 dark:text-gray-400 font-mono">${item.closing_rank ?? 'N/A'}</td>
                                            <td class="px-6 py-4 align-middle whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${item.year ?? 'N/A'}</td>
                                            <td class="px-6 py-4 align-middle whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${item.round || 'N/A'}</td>
                                            <td class="px-6 py-4 align-middle whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${item.quota || 'N/A'}</td>
                                            <td class="px-6 py-4 align-middle whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${item.seat_type || 'N/A'}</td>
                        `;
                        fragment.appendChild(row);
                    });
                            
                    tableBody.appendChild(fragment);
                            
                            setTimeout(() => {
                                addTableEventListeners();
                            }, 0);
                        }
                    };
                    
                    renderRowsOptimized(paginatedData);
                    
                    const startNum = totalItems > 0 ? startIndex + 1 : 0;
                    const endNum = entriesPerPage === 'all' ? totalItems : Math.min(endIndex, totalItems);
                    resultsCountSpan.innerHTML = `<span class="text-gray-900 dark:text-white">Showing ${startNum.toLocaleString()} to ${endNum.toLocaleString()} of ${totalItems.toLocaleString()} records</span>`;
                }
                
                if (isShowingFavorites) updateCompareButtonState();
                updatePaginationUI(totalPages);
            }
            
            function updateFilterButtonLabels() {
                filterKeys.forEach(key => {
                    const button = document.getElementById(`${key}-filter-btn`);
                    if(!button) return;
                    const title = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    const count = activeFilters[key].length;
                    const label = button.querySelector('.filter-btn-label');
                    label.innerHTML = `<span class="text-gray-700 dark:text-gray-300">${count > 0 ? `${title} (${count} selected)` : `${title} (All)`}</span>`;
                    button.querySelector('.clear-single-filter').classList.toggle('hidden', count === 0);
                });
            }

            function updateHeaderStyles() {
                tableHeaders.forEach(header => {
                    header.classList.remove('sorted-asc', 'sorted-desc', 'bg-gray-200');
                    const indicator = header.querySelector('.sort-indicator');
                    if (!indicator) return;
                    
                    if (header.dataset.column === sortState.column) {
                        header.classList.add('bg-gray-200');
                        if (sortState.direction === 'asc') {
                            header.classList.add('sorted-asc');
                            indicator.textContent = '';
                        } else if (sortState.direction === 'desc') {
                            header.classList.add('sorted-desc');
                            indicator.textContent = '';
                        } else {
                            indicator.textContent = '';
                        }
                    } else {
                        indicator.textContent = '';
                    }
                });
            }

            function updatePaginationUI(totalPages) {
                paginationNav.classList.toggle('hidden', totalPages <= 1);
                pageInfoSpan.innerHTML = `<span class="text-gray-700 dark:text-gray-300">Page ${currentPage} of ${totalPages}</span>`;
                prevPageButton.disabled = currentPage === 1;
                nextPageButton.disabled = currentPage >= totalPages;
            }

            function updateURLWithFilters() {
                const obj = { rank: activeFilters.rank };
                filterKeys.forEach(key => {
                    obj[key] = activeFilters[key].map(val => filterIdMaps[key].get(val)).filter(Boolean);
                });
                const b64 = btoa(unescape(encodeURIComponent(JSON.stringify(obj))));
                const newUrl = `${window.location.pathname}?f=${b64}`;
                history.pushState({ path: newUrl }, '', newUrl);
            }

            function loadFiltersFromURL() {
                const params = new URLSearchParams(window.location.search);
                const savedFilters = JSON.parse(localStorage.getItem('wbjeeFilters'));

                const sharedShortlist = params.get('shortlist');
                if (sharedShortlist) {
                    const shortlistIds = sharedShortlist.split(',').filter(id => id.trim());
                    if (shortlistIds.length > 0) {
                                            favorites.clear();
                        shortlistIds.forEach(id => favorites.add(id));
                        saveFavorites();
                        
                                            isShowingFavorites = true;
                        favoritesBtnText.innerHTML = '<span class="text-white">Show All</span>';
                        compareFavoritesBtn.classList.remove('hidden');
                        
                        rankInput.value = '';
                        initializeFilters();
                        document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
                        applyFiltersAndRender(false);
                        updateFavoritesUI();
                        return;
                    }
                }

                const b64 = params.get('f');
                if (b64) {
                    const decoded = decodeFiltersFromBase64(b64);
                    if (decoded) {
                        rankInput.value = decoded.rank || '';
                    updateFilterState('rank', rankInput.value);
                    filterKeys.forEach(key => {
                            if (decoded[key]) decoded[key].forEach(val => updateFilterState(key, val, true));
                    });
                    }
                } else if (savedFilters) {
                    rankInput.value = savedFilters.rank || '';
                    filterKeys.forEach(key => {
                        if (savedFilters[key]) {
                           savedFilters[key].forEach(value => updateFilterState(key, value, true));
                        }
                    });
                }
                
                document.querySelectorAll('.filter-checkbox').forEach(cb => {
                    const key = cb.dataset.filterKey;
                    cb.checked = activeFilters[key].includes(cb.value);
                });
            }

            function saveFavorites() {
                localStorage.setItem('wbjeeFavorites', JSON.stringify(Array.from(favorites)));
                updateFavoritesUI();
            }
            
            function updateTieringButtonUI() {
                const tieringBtnText = document.getElementById('tiering-btn-text');
                const tieringBtn = document.getElementById('tiering-btn');
                const resultsTable = document.getElementById('results-table');
                
                if (tieringBtnText) {
                    tieringBtnText.innerHTML = `<span style="color: white !important;">${isTieringEnabled ? 'Hide Predictions' : 'Show Predictions'}</span>`;
                }
                
                if (tieringBtn) {
                tieringBtn.classList.toggle('bg-gray-300', !isTieringEnabled);
                }
                
                if (resultsTable) {
                    resultsTable.classList.toggle('predictions-hidden', !isTieringEnabled);
                }
            }

            function updateFavoritesUI() {
                favoritesCountBadge.textContent = favorites.size;
                favoritesCountBadge.classList.toggle('hidden', favorites.size === 0);
                
                const shortlistBtn = document.getElementById('show-favorites-btn');
                if (shortlistBtn) {
                    const btnText = shortlistBtn.querySelector('.btn-text');
                    if (btnText) {
                        btnText.innerHTML = `<span class="text-white">Show Shortlist (${favorites.size})</span>`;
                    }
                }
            }

            function updateCompareButtonState() {
                const selectedCount = tableBody.querySelectorAll('.compare-checkbox:checked').length;
                const canCompare = selectedCount >= CONFIG.COMPARISON_MIN && selectedCount <= CONFIG.COMPARISON_MAX;
                compareFavoritesBtn.disabled = !canCompare;
                compareFavoritesBtn.innerHTML = `<span class="text-white">Compare Selected (${selectedCount})</span>`;
            }

            function initBackToTop() {
                const backToTopBtn = document.getElementById('back-to-top');
                if (!backToTopBtn) return;
                
                window.addEventListener('scroll', () => {
                    if (window.pageYOffset > 300) {
                        backToTopBtn.classList.add('visible');
                    } else {
                        backToTopBtn.classList.remove('visible');
                    }
                });
                
                backToTopBtn.addEventListener('click', () => {
                    window.scrollTo({
                        top: 0,
                        behavior: 'smooth'
                    });
                });
                
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Home') {
                        e.preventDefault();
                        window.scrollTo({
                            top: 0,
                            behavior: 'smooth'
                        });
                    }
                });
            }
            
            function showCollegeDetails(instituteName) {
                const modal = document.getElementById('college-details-modal');
                const title = document.getElementById('college-details-title');
                const body = document.getElementById('college-details-body');
                
                const collegeData = allData.filter(item => item.institute === instituteName);
                const branches = [...new Set(collegeData.map(item => item.branch))];
                const categories = [...new Set(collegeData.map(item => item.category))];
                const years = [...new Set(collegeData.map(item => item.year))].sort((a, b) => b - a);
                
                title.textContent = instituteName;
                
                const avgClosingRank = Math.round(collegeData.reduce((sum, item) => sum + (item.closing_rank || 0), 0) / collegeData.length);
                const minRank = Math.min(...collegeData.map(item => item.closing_rank || Infinity));
                const maxRank = Math.max(...collegeData.map(item => item.closing_rank || 0));
                
                body.innerHTML = `
                    <div class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg">
                                <h4 class="font-semibold text-blue-800 dark:text-blue-200">Average Closing Rank</h4>
                                <p class="text-2xl font-bold text-blue-600 dark:text-blue-300">${avgClosingRank.toLocaleString()}</p>
                            </div>
                            <div class="bg-green-50 dark:bg-green-900/20 p-4 rounded-lg">
                                <h4 class="font-semibold text-green-800 dark:text-green-200">Best Rank</h4>
                                <p class="text-2xl font-bold text-green-600 dark:text-green-300">${minRank === Infinity ? 'N/A' : minRank.toLocaleString()}</p>
                            </div>
                            <div class="bg-orange-50 dark:bg-orange-900/20 p-4 rounded-lg">
                                <h4 class="font-semibold text-orange-800 dark:text-orange-200">Worst Rank</h4>
                                <p class="text-2xl font-bold text-orange-600 dark:text-orange-300">${maxRank === 0 ? 'N/A' : maxRank.toLocaleString()}</p>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <h4 class="font-semibold text-gray-900 dark:text-white mb-3">Available Branches (${branches.length})</h4>
                                <div class="space-y-2">
                                    ${branches.map(branch => `<div class="bg-gray-50 dark:bg-gray-700 px-3 py-2 rounded text-sm">${branch}</div>`).join('')}
                                </div>
                            </div>
                            <div>
                                <h4 class="font-semibold text-gray-900 dark:text-white mb-3">Categories</h4>
                                <div class="space-y-2">
                                    ${categories.map(cat => `<div class="bg-gray-50 dark:bg-gray-700 px-3 py-2 rounded text-sm">${cat}</div>`).join('')}
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <h4 class="font-semibold text-gray-900 dark:text-white mb-3">Recent Years Data</h4>
                            <div class="overflow-x-auto">
                                <table class="min-w-full text-sm">
                                    <thead>
                                        <tr class="border-b border-gray-200 dark:border-gray-700">
                                            <th class="text-left py-2">Year</th>
                                            <th class="text-left py-2">Branches</th>
                                            <th class="text-left py-2">Avg Rank</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${years.slice(0, 5).map(year => {
                                            const yearData = collegeData.filter(item => item.year === year);
                                            const avgRank = Math.round(yearData.reduce((sum, item) => sum + (item.closing_rank || 0), 0) / yearData.length);
                                            return `<tr class="border-b border-gray-100 dark:border-gray-800">
                                                <td class="py-2">${year}</td>
                                                <td class="py-2">${yearData.length}</td>
                                                <td class="py-2 font-mono">${avgRank.toLocaleString()}</td>
                                            </tr>`;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div class="flex gap-3 pt-4 border-t border-gray-200 dark:border-gray-700">
                            <button onclick="shareCollege('${instituteName}')" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors">
                                 Share College
                            </button>
                            <button onclick="addAllBranchesToFavorites('${instituteName}')" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition-colors">
                                 Add All to Shortlist
                            </button>
                        </div>
                    </div>
                `;
                
                modal.classList.remove('hidden');
            }

            function addEventListeners() {
                rankInput.addEventListener('keydown', (e) => {
                    if (['e', '+', '-', '.'].includes(e.key)) {
                    e.preventDefault();
    }
});
                rankInput.addEventListener('input', () => {
                    if (parseInt(rankInput.value, 10) < 1) {
                        rankInput.value = '';
                    }
                    updateFilterState('rank', rankInput.value);
                });

                searchButton.addEventListener('click', () => {
                    if (rankInput.value === '') {
                        showInputErrorModal();
                        return;
                    }
                    
                    const originalText = searchButton.textContent || 'Search';
                    searchButton.innerHTML = '<span class="text-white">Searching...</span>';
                    searchButton.disabled = true;
                    
                    applyFiltersAndRender(false);
                    
                    setTimeout(() => {
                        searchButton.innerHTML = `<span class="text-white">${originalText}</span>`;
                        searchButton.disabled = false;
                    }, 1000);
                });
                
                resetButton.addEventListener('click', () => {
                    rankInput.value = '';
                    initializeFilters(); 
                    document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
                    
                    sortState = { column: null, direction: 'none', type: 'string' };

                    entriesPerPageSelect.value = '50';
                    entriesPerPage = 50;
                    lastEntriesPerPageValue = '50';

                    if (isShowingFavorites) {
                        isShowingFavorites = false;
                        favoritesBtnText.innerHTML = '<span class="text-white">Show Shortlist</span>';
                        compareFavoritesBtn.classList.add('hidden');
                    }
                    localStorage.removeItem('wbjeeFilters');
                    applyFiltersAndRender(false);
                });



                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.filter-dropdown')) {
                        document.querySelectorAll('.filter-panel').forEach(p => p.classList.add('hidden'));
                    }
                    if (e.target.classList.contains('favorite-btn') || e.target.closest('.favorite-btn')) {
                        const btn = e.target.classList.contains('favorite-btn') ? e.target : e.target.closest('.favorite-btn');
                        const id = btn.dataset.id;
                        if (favorites.has(id)) favorites.delete(id);
                        else favorites.add(id);
                        saveFavorites();
                        if(isShowingFavorites) {
                            applyFiltersAndRender(false);
                        } else {
                            btn.classList.toggle('favorited', favorites.has(id));
                        }
                    }
                });

                document.querySelectorAll('.filter-dropdown').forEach(container => {
                    container.addEventListener('click', (e) => {
                        if (e.target.closest('.filter-btn')) {
                            e.stopPropagation();
                            const panel = e.target.closest('.filter-btn').nextElementSibling;
                            document.querySelectorAll('.filter-panel').forEach(p => {
                                if (p !== panel) p.classList.add('hidden');
                            });
                            panel.classList.toggle('hidden');
                        }
                        if (e.target.closest('.clear-single-filter')) {
                            e.stopPropagation();
                            const key = e.target.closest('.clear-single-filter').dataset.key;
                            activeFilters[key] = [];
                            container.querySelectorAll('.filter-checkbox').forEach(cb => cb.checked = false);
                            applyFiltersAndRender(false);
                        }
                    });
                    
                    container.addEventListener('change', (e) => {
                        if (e.target.classList.contains('filter-checkbox')) {
                            updateFilterState(e.target.dataset.filterKey, e.target.value, e.target.checked);
                        }
                    });

                    container.addEventListener('click', (e) => {
                        if (e.target.classList.contains('done-filter-btn')) {
                            e.stopPropagation();
                            const panel = e.target.closest('.filter-panel');
                            panel.classList.add('hidden');
                        }
                    });
                });

                tableHeaders.forEach(header => {
                    header.addEventListener('click', () => {
                        const column = header.dataset.column;
                        if (!column) return;
                        
                        if (sortState.column === column) {
                            sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
                        } else {
                            sortState.column = column;
                            sortState.direction = 'asc';
                            sortState.type = header.dataset.type || 'string';
                        }
                        
                        applySorting();
                        renderTable();
                    });
                });



        const virtualScrollToggle = document.getElementById('virtual-scroll-toggle');
        const virtualScrollContainer = document.getElementById('virtual-scroll-container');
        const virtualScrollBody = document.getElementById('virtual-scroll-body');
        const resultsTable = document.getElementById('results-table');

        const rankDistributionBtn = document.getElementById('rank-distribution-btn');
        const rankDistributionModal = document.getElementById('rank-distribution-modal');
        const closeRankDistributionModal = document.getElementById('close-rank-distribution-modal');
        let rankDistributionChart = null;

        function initializeVirtualScroll() {
            if (!virtualScrollContainer || !virtualScrollBody) return;
            
            const containerHeight = virtualScrollConfig.visibleItems * virtualScrollConfig.itemHeight;
            virtualScrollContainer.style.height = `${containerHeight}px`;
            virtualScrollContainer.addEventListener('scroll', handleVirtualScroll);
        }

        function handleVirtualScroll() {
            if (!isVirtualScrollEnabled || virtualScrollData.length === 0) return;
            
            const scrollTop = virtualScrollContainer.scrollTop;
            const containerHeight = virtualScrollContainer.clientHeight;
            
            const startIndex = Math.floor(scrollTop / virtualScrollConfig.itemHeight);
            const endIndex = Math.min(
                startIndex + virtualScrollConfig.visibleItems + virtualScrollConfig.buffer,
                virtualScrollData.length
            );
        
            renderVirtualScrollItems(startIndex, endIndex);
            
            const spacerHeight = startIndex * virtualScrollConfig.itemHeight;
            virtualScrollBody.style.paddingTop = `${spacerHeight}px`;
            virtualScrollBody.style.paddingBottom = `${(virtualScrollData.length - endIndex) * virtualScrollConfig.itemHeight}px`;
        }

        function renderVirtualScrollItems(startIndex, endIndex) {
            if (!virtualScrollBody) return;
            
            virtualScrollBody.innerHTML = '';
            
            for (let i = startIndex; i < endIndex; i++) {
                const item = virtualScrollData[i];
                if (!item) continue;
                
                const row = createTableRow(item, i);
                virtualScrollBody.appendChild(row);
            }
        }

        function createTableRow(item, index) {
            const row = document.createElement('tr');
            row.className = 'virtual-scroll-item';
            row.dataset.index = index;
            
            const isFavorited = favorites.has(item.id);
            const favAriaLabel = isFavorited ? `Remove ${item.institute} - ${item.branch} from shortlist` : `Add ${item.institute} - ${item.branch} to shortlist`;
            
            const predictionBadge = getPredictionBadge(item.prediction);
            
            row.innerHTML = `
                <td class="text-center">
                    <button onclick="toggleFavorite('${item.id}')" class="text-2xl transition-colors ${isFavorited ? 'text-yellow-500' : 'text-gray-300 hover:text-yellow-400'}" aria-label="${favAriaLabel}" title="${isFavorited ? 'Remove from shortlist' : 'Add to shortlist'}"></button>
                </td>
                <td>
                    ${predictionBadge}
                </td>
                <td class="font-medium">
                    <a href="#" onclick="showCollegeDetails('${item.institute}')" class="hover:text-blue-600 dark:hover:text-blue-400 transition-colors" aria-label="View details for ${item.institute}">${item.institute}</a>
                </td>
                <td>${item.branch}</td>
                <td>${item.category}</td>
                <td>${item.opening_rank ? item.opening_rank.toLocaleString() : 'N/A'}</td>
                <td>${item.closing_rank ? item.closing_rank.toLocaleString() : 'N/A'}</td>
                <td>${item.year}</td>
                <td>${item.round}</td>
                <td>${item.quota}</td>
                <td>${item.seat_type || 'N/A'}</td>
            `;
            
            row.addEventListener('click', (e) => {
                if (!e.target.closest('button') && !e.target.closest('a')) {
                    const identifier = { institute: item.institute, branch: item.branch, category: item.category, quota: item.quota, seat_type: item.seat_type };
                    showRankTrendChart(identifier);
                }
            });
            
            return row;
        }

        function toggleVirtualScroll() {
            isVirtualScrollEnabled = !isVirtualScrollEnabled;
            
            if (isVirtualScrollEnabled) {
                virtualScrollContainer.classList.remove('hidden');
                resultsTable.classList.add('hidden');
                virtualScrollToggle.textContent = 'Disable Virtual Scroll';
                virtualScrollToggle.classList.add('bg-green-600', 'text-white');
                virtualScrollToggle.classList.remove('bg-gray-200', 'text-gray-700', 'dark:bg-gray-700', 'dark:text-gray-300');
                
                if (filteredData.length > 0) {
                    virtualScrollData = [...filteredData];
                    initializeVirtualScroll();
                    handleVirtualScroll();
                }
            } else {
                virtualScrollContainer.classList.add('hidden');
                resultsTable.classList.remove('hidden');
                virtualScrollToggle.textContent = 'Enable Virtual Scroll';
                updateVirtualScrollButtonStyle();
            }
        }

        function updateVirtualScrollButtonStyle() {
            const isDark = document.documentElement.classList.contains('dark');
            if (virtualScrollToggle && !isVirtualScrollEnabled) {
                if (isDark) {
                    virtualScrollToggle.style.setProperty('background-color', 'rgb(55 65 81)', 'important');
                    virtualScrollToggle.style.setProperty('color', 'rgb(209 213 219)', 'important');
                } else {
                    virtualScrollToggle.style.setProperty('background-color', 'rgb(229 231 235)', 'important');
                    virtualScrollToggle.style.setProperty('color', 'rgb(55 65 81)', 'important');
                }
            }
        }

        function updateRankDistributionButtonStyle() {
            const isDark = document.documentElement.classList.contains('dark');
            if (rankDistributionBtn) {
                if (isDark) {
                    rankDistributionBtn.style.setProperty('background-color', 'rgb(55 65 81)', 'important');
                    rankDistributionBtn.style.setProperty('color', 'rgb(209 213 219)', 'important');
                } else {
                    rankDistributionBtn.style.setProperty('background-color', 'rgb(229 231 235)', 'important');
                    rankDistributionBtn.style.setProperty('color', 'rgb(55 65 81)', 'important');
                }
            }
        }

                updateRankDistributionButtonStyle();
                updateVirtualScrollButtonStyle();
                document.addEventListener('DOMContentLoaded', () => {
                    updateRankDistributionButtonStyle();
                    updateVirtualScrollButtonStyle();
                });
                
                const observer = new MutationObserver((mutations) => {
                    mutations.forEach((mutation) => {
                        if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                            if (mutation.target === document.documentElement) {
                                setTimeout(() => {
                                    updateRankDistributionButtonStyle();
                                    updateVirtualScrollButtonStyle();
                                }, 10);
                            }
                        }
                    });
                });
                
                observer.observe(document.documentElement, {
                    attributes: true,
                    attributeFilter: ['class']
                });

                        if (virtualScrollToggle) {
                    virtualScrollToggle.addEventListener('click', toggleVirtualScroll);
                }

                rankDistributionBtn.addEventListener('click', () => {
                    if (filteredData.length === 0) {
                        showModal('No Data', 'No colleges found. Please enter a rank and search first!', 'warning');
                        return;
                    }
                    rankDistributionModal.classList.remove('hidden');
                    showRankDistribution();
                });

                closeRankDistributionModal.addEventListener('click', () => {
                    rankDistributionModal.classList.add('hidden');
                    if (rankDistributionChart) {
                        rankDistributionChart.destroy();
                        rankDistributionChart = null;
                    }
                });

                function showRankDistribution() {
                    const userRank = parseInt(rankInput.value) || 0;
                    const ranks = filteredData
                        .map(item => item.closing_rank)
                        .filter(rank => rank && rank > 0)
                        .sort((a, b) => a - b);

                    if (ranks.length === 0) {
                        showModal('No Data', 'No valid closing ranks found in the current results.', 'warning');
                        return;
                    }

                    const minRank = Math.min(...ranks);
                    const maxRank = Math.max(...ranks);
                    const range = maxRank - minRank;
                    const binCount = Math.min(10, Math.ceil(Math.sqrt(ranks.length))); // Dynamic bin count
                    const binSize = Math.ceil(range / binCount);

                                    const bins = [];
                    for (let i = 0; i < binCount; i++) {
                        const binStart = minRank + (i * binSize);
                        const binEnd = binStart + binSize;
                        const count = ranks.filter(rank => rank >= binStart && rank < binEnd).length;
                        bins.push({
                            range: `${binStart.toLocaleString()} - ${(binEnd - 1).toLocaleString()}`,
                            count: count,
                            start: binStart,
                            end: binEnd
                        });
                    }

                    const userRankIndicator = document.getElementById('user-rank-indicator');
                    if (userRank > 0) {
                        userRankIndicator.textContent = `Your Rank: ${userRank.toLocaleString()}`;
                        userRankIndicator.style.display = 'inline-block';
                    } else {
                        userRankIndicator.style.display = 'none';
                    }

                    createRankDistributionChart(bins, userRank);
                }

                function createRankDistributionChart(bins, userRank) {
                    const ctx = document.getElementById('rank-distribution-chart');
                    
                    if (rankDistributionChart) {
                        rankDistributionChart.destroy();
                    }

                    const isDark = document.documentElement.classList.contains('dark');
                    const textColor = isDark ? '#e5e7eb' : '#374151';
                    const gridColor = isDark ? '#374151' : '#e5e7eb';

                    const userBinIndex = bins.findIndex(bin => userRank >= bin.start && userRank < bin.end);

                    rankDistributionChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: bins.map(bin => bin.range),
                            datasets: [{
                                label: 'Number of Colleges',
                                data: bins.map((bin, index) => bin.count),
                                backgroundColor: bins.map((bin, index) => {
                                    if (userRank > 0 && index === userBinIndex) {
                                        return '#3B82F6';
                                    }
                                    return '#10B981';
                                }),
                                borderColor: bins.map((bin, index) => {
                                    if (userRank > 0 && index === userBinIndex) {
                                        return '#2563EB';
                                    }
                                    return '#059669';
                                }),
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'Distribution of Closing Ranks',
                                    color: textColor,
                                    font: {
                                        size: 16,
                                        weight: 'bold'
                                    }
                                },
                                legend: {
                                    display: false
                                },
                                tooltip: {
                                    backgroundColor: isDark ? '#374151' : '#ffffff',
                                    titleColor: textColor,
                                    bodyColor: textColor,
                                    borderColor: gridColor,
                                    borderWidth: 1,
                                    callbacks: {
                                        label: function(context) {
                                            return `Colleges: ${context.parsed.y}`;
                                        },
                                        afterLabel: function(context) {
                                            const bin = bins[context.dataIndex];
                                            if (userRank > 0 && context.dataIndex === userBinIndex) {
                                                return `Your rank (${userRank.toLocaleString()}) is in this range`;
                                            }
                                            return `Rank range: ${bin.range}`;
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    grid: {
                                        color: gridColor
                                    },
                                    ticks: {
                                        color: textColor
                                    },
                                    title: {
                                        display: true,
                                        text: 'Number of Colleges',
                                        color: textColor
                                    }
                                },
                                x: {
                                    grid: {
                                        color: gridColor
                                    },
                                    ticks: {
                                        color: textColor,
                                        maxRotation: 45
                                    },
                                    title: {
                                        display: true,
                                        text: 'Closing Rank Range',
                                        color: textColor
                                    }
                                }
                            }
                        }
                    });
                }

                let lastEntriesPerPageValue = entriesPerPageSelect.value;
                entriesPerPageSelect.addEventListener('change', (e) => {
                    if (e.target.value === 'all' && (!rankInput.value || !rankInput.value.trim())) {
                        showModal('Rank Required', 'Please enter your rank before viewing all results.', 'warning');
                        e.target.value = lastEntriesPerPageValue;
                        return;
                    }
                    
                    if (e.target.value === 'all' && filteredData.length > 3000) {
                        const confirmLoad = confirm(`You're about to load ${filteredData.length.toLocaleString()} records. This may take a moment and could slow down your browser.\n\nConsider using filters to reduce the dataset size for better performance.\n\nClick OK to continue or Cancel to keep current pagination.`);
                        if (!confirmLoad) {
                            e.target.value = lastEntriesPerPageValue;
                            return;
                        }
                    }
                    
                    entriesPerPage = e.target.value === 'all' ? 'all' : Number(e.target.value);
                    lastEntriesPerPageValue = e.target.value;
                    currentPage = 1;
                    renderTable();
                });
                prevPageButton.addEventListener('click', () => { if (currentPage > 1) { currentPage--; renderTable(); } });
                nextPageButton.addEventListener('click', () => {
                    const totalPages = entriesPerPage === 'all' ? 1 : Math.ceil(filteredData.length / entriesPerPage);
                    if (currentPage < totalPages) { currentPage++; renderTable(); }
                });

                let startX = 0;
                let currentX = 0;
                
                paginationNav.addEventListener('touchstart', (e) => {
                    startX = e.touches[0].clientX;
                }, { passive: true });
                
                paginationNav.addEventListener('touchend', (e) => {
                    currentX = e.changedTouches[0].clientX;
                    const diff = startX - currentX;
                    const threshold = 50;
                    
                    if (Math.abs(diff) > threshold) {
                        if (diff > 0) {
                            const totalPages = entriesPerPage === 'all' ? 1 : Math.ceil(filteredData.length / entriesPerPage);
                            if (currentPage < totalPages) { 
                                currentPage++; 
                                renderTable(); 
                            }
                        } else {
                            if (currentPage > 1) { 
                                currentPage--; 
                                renderTable(); 
                            }
                        }
                    }
                }, { passive: true });
                showFavoritesBtn.addEventListener('click', () => {
                    if (!isShowingFavorites && favorites.size === 0 && (!rankInput.value || !rankInput.value.trim())) {
                        showModal('Rank Required', 'Please enter your rank to view eligible colleges.', 'warning');
                        return;
                    }
                    isShowingFavorites = !isShowingFavorites;
                    favoritesBtnText.innerHTML = `<span class="text-white">${isShowingFavorites ? 'Show All' : 'Show Shortlist'}</span>`;
                    compareFavoritesBtn.classList.toggle('hidden', !isShowingFavorites);
                    applyFiltersAndRender(false);
                });
                tableBody.addEventListener('click', (e) => {
                    const favBtn = e.target.closest('.favorite-btn');
                    if (favBtn) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        const row = favBtn.closest('tr');
                        if (!row) return;
                        
                        const identifier = JSON.parse(row.dataset.identifier);
                        const item = allData.find(d =>
                          d.institute === identifier.institute &&
                          d.branch === identifier.branch &&
                          d.category === identifier.category &&
                          d.quota === identifier.quota &&
                          d.seat_type === identifier.seat_type
                        );
                        if (!item) return;
                        
                        const id = item.id;
                        const wasFavorited = favorites.has(id);
                        
                        if (wasFavorited) {
                            favorites.delete(id);
                        } else {
                            favorites.add(id);
                        }
                        
                        saveFavorites();
                        
                        if (wasFavorited) {
                            favBtn.classList.remove('favorited');
                        } else {
                            favBtn.classList.add('favorited');
                        }
                        
                        updateFavoritesUI();
                        

                        if (isShowingFavorites) {
                            renderTable();
                        }
                        
                        return;
                    }
                    const instituteLink = e.target.closest('.institute-link');
                    if (instituteLink) {
                        showCollegeDetails(instituteLink.dataset.institute);
                        return;
                    }
                    const row = e.target.closest('tr');
                    if (row && row.dataset.identifier && !e.target.closest('button, a, input, label')) {
                        showRankTrendChart(JSON.parse(row.dataset.identifier));
                    }
                });
                tableBody.addEventListener('change', (e) => {
                    if (e.target.classList.contains('compare-checkbox')) {
                        updateCompareButtonState();
                    }
                });
                if (tieringBtn) {
                tieringBtn.addEventListener('click', () => {
                    isTieringEnabled = !isTieringEnabled;
                    localStorage.setItem('wbjeeTieringEnabled', isTieringEnabled);
                    updateTieringButtonUI();
                });
                }
                closeChartModalBtn.addEventListener('click', () => chartModal.classList.add('hidden'));
                closeCollegeDetailsModalBtn.addEventListener('click', () => collegeDetailsModal.classList.add('hidden'));
                closeComparisonModalBtn.addEventListener('click', () => comparisonModal.classList.add('hidden'));
                
                collegeDetailsModal.addEventListener('click', (e) => {
                    if (e.target === collegeDetailsModal) {
                        collegeDetailsModal.classList.add('hidden');
                    }
                });
                
                chartModal.addEventListener('click', (e) => {
                    if (e.target === chartModal) {
                        chartModal.classList.add('hidden');
                    }
                });
                
                comparisonModal.addEventListener('click', (e) => {
                    if (e.target === comparisonModal) {
                        comparisonModal.classList.add('hidden');
                    }
                });
                compareFavoritesBtn.addEventListener('click', () => {
                    const selectedToCompare = Array.from(document.querySelectorAll('.compare-checkbox:checked')).map(cb => cb.dataset.id);
                    showComparison(selectedToCompare);
                });

                const legendPopoverBtn = document.getElementById('legend-popover-btn');
                const legendModal = document.getElementById('legend-modal');
                const closeLegendModalBtn = document.getElementById('close-legend-modal');

                legendPopoverBtn.addEventListener('click', () => {
                    legendModal.classList.remove('hidden');
                });
                closeLegendModalBtn.addEventListener('click', () => {
                    legendModal.classList.add('hidden');
                });
                legendModal.addEventListener('click', (e) => {
                    if (e.target === legendModal) {
                        legendModal.classList.add('hidden');
                    }
                });

                const inputErrorModal = document.getElementById('input-error-modal');
                const closeInputErrorModalBtn = document.getElementById('close-input-error-modal');
                
                closeInputErrorModalBtn.addEventListener('click', () => {
                    inputErrorModal.classList.add('hidden');
                });
                
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        const modals = [
                            inputErrorModal,
                            helpModal,
                            collegeDetailsModal,
                            chartModal,
                            comparisonModal,
                            jsonErrorOverlay,
                            document.getElementById('general-modal')
                        ];
                        
                        modals.forEach(modal => {
                            if (modal && !modal.classList.contains('hidden')) {
                                modal.classList.add('hidden');
                            }
                        });
                    }
                });
                
                inputErrorModal.addEventListener('click', (e) => {
                    if (e.target === inputErrorModal) {
                        inputErrorModal.classList.add('hidden');
                    }
                });

                const helpModal = document.getElementById('help-modal');
                const closeHelpModalBtn = document.getElementById('close-help-modal');
                const openHelpModalBtn = document.getElementById('open-help-modal');

                openHelpModalBtn.addEventListener('click', () => {
                    helpModal.classList.remove('hidden');
                });
                closeHelpModalBtn.addEventListener('click', () => {
                    helpModal.classList.add('hidden');
                });
                helpModal.addEventListener('click', (e) => {
                    if (e.target === helpModal) {
                        helpModal.classList.add('hidden');
                    }
                });

                const jsonErrorOverlay = document.getElementById('json-error-overlay');
                const retryLoadBtn = document.getElementById('retry-load-btn');

                retryLoadBtn.addEventListener('click', () => {
                    jsonErrorOverlay.classList.add('hidden');
                    initializeApp();
                });
                
                jsonErrorOverlay.addEventListener('click', (e) => {
                    if (e.target === jsonErrorOverlay) {
                        jsonErrorOverlay.classList.add('hidden');
                    }
                });

                // Export & Share Dropdown Functionality
                const exportShareDropdownBtn = document.getElementById('export-share-dropdown-btn');
                const exportShareDropdown = document.getElementById('export-share-dropdown');

                // Toggle dropdown
                exportShareDropdownBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    exportShareDropdown.classList.toggle('hidden');
                });

                // Close dropdown when clicking outside
                document.addEventListener('click', (e) => {
                    if (!exportShareDropdownBtn.contains(e.target) && !exportShareDropdown.contains(e.target)) {
                        exportShareDropdown.classList.add('hidden');
                    }
                });

                // Export Results CSV
                document.getElementById('export-results-csv').addEventListener('click', () => {
                    if (filteredData.length === 0) {
                        showModal('No Data', 'No results to export. Please search for colleges first!', 'warning');
                        return;
                    }
                    exportToCSV();
                    exportShareDropdown.classList.add('hidden');
                });

                // Export Shortlist CSV
                document.getElementById('export-shortlist-csv').addEventListener('click', () => {
                    if (favorites.size === 0) {
                        showModal('Empty Shortlist', 'Your shortlist is empty. Add some colleges first!', 'warning');
                        return;
                    }
                    const shortlistData = allData.filter(item => favorites.has(item.id));
                    exportShortlistToCSV(shortlistData);
                    exportShareDropdown.classList.add('hidden');
                });

                // Export Results PDF
                document.getElementById('export-results-pdf').addEventListener('click', () => {
                    if (filteredData.length === 0) {
                        showModal('No Data', 'No results to export. Please search for colleges first!', 'warning');
                        return;
                    }
                    exportToPDF(filteredData, 'wbjee_results.pdf');
                    exportShareDropdown.classList.add('hidden');
                });

                // Export Shortlist PDF
                document.getElementById('export-shortlist-pdf').addEventListener('click', () => {
                    if (favorites.size === 0) {
                        showModal('Empty Shortlist', 'Your shortlist is empty. Add some colleges first!', 'warning');
                        return;
                    }
                    const shortlistData = allData.filter(item => favorites.has(item.id));
                    exportToPDF(shortlistData, 'wbjee_shortlist.pdf');
                    exportShareDropdown.classList.add('hidden');
                });

                // Share Results
                document.getElementById('share-results').addEventListener('click', () => {
                    if (!rankInput.value) {
                        showModal('Rank Required', 'Please enter a rank first to share results!', 'warning');
                        return;
                    }
                    const obj = { rank: activeFilters.rank };
                    filterKeys.forEach(key => {
                        obj[key] = activeFilters[key].map(val => filterIdMaps[key].get(val)).filter(Boolean);
                    });
                    const b64 = btoa(unescape(encodeURIComponent(JSON.stringify(obj))));
                    const shareUrl = `${window.location.origin}${window.location.pathname}?f=${b64}`;
                    copyToClipboard(shareUrl, 'Results link copied to clipboard!');
                    exportShareDropdown.classList.add('hidden');
                });

                // Share Shortlist
                document.getElementById('share-shortlist').addEventListener('click', () => {
                    if (favorites.size === 0) {
                        showModal('Empty Shortlist', 'Your shortlist is empty. Add some colleges first!', 'warning');
                        return;
                    }
                    const shortlistIds = Array.from(favorites);
                    const shareUrl = `${window.location.origin}${window.location.pathname}?shortlist=${shortlistIds.join(',')}`;
                    copyToClipboard(shareUrl, 'Shortlist link copied to clipboard!');
                    exportShareDropdown.classList.add('hidden');
                });

                // Share Everything
                document.getElementById('share-everything').addEventListener('click', () => {
                    copyToClipboard(window.location.href, 'Full page link copied to clipboard!');
                    exportShareDropdown.classList.add('hidden');
                });

                // Copy Results Text
                document.getElementById('copy-results-text').addEventListener('click', () => {
                    if (filteredData.length === 0) {
                        showModal('No Data', 'No results to copy. Please search for colleges first!', 'warning');
                        return;
                    }
                    const text = formatResultsAsText(filteredData);
                    copyToClipboard(text, 'Results copied as text!');
                    exportShareDropdown.classList.add('hidden');
                });

                // Copy College Codes
                document.getElementById('copy-college-codes').addEventListener('click', () => {
                    const dataToUse = isShowingFavorites ? 
                        allData.filter(item => favorites.has(item.id)) : 
                        filteredData;
                    
                    if (dataToUse.length === 0) {
                        showModal('No Data', 'No colleges to copy. Please search for colleges first!', 'warning');
                        return;
                    }
                    
                    const codes = dataToUse.map(item => item.institute).filter((code, index, arr) => arr.indexOf(code) === index);
                    copyToClipboard(codes.join('\n'), 'College codes copied to clipboard!');
                    exportShareDropdown.classList.add('hidden');
                });

                // Helper Functions
                function copyToClipboard(text, successMessage) {
                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        navigator.clipboard.writeText(text).then(() => {
                            showModal('Success', successMessage, 'success');
                        }).catch(() => {
                            showModal('Copy Failed', `Please copy manually:\n\n${text}`, 'info');
                        });
                    } else {
                        showModal('Copy Failed', `Please copy manually:\n\n${text}`, 'info');
                    }
                }

                function formatResultsAsText(data) {
                    const userRank = parseInt(rankInput.value) || 0;
                    let text = `WBJEE College Predictor Results\n`;
                    text += `Generated on: ${new Date().toLocaleDateString()}\n`;
                    if (userRank > 0) text += `Your Rank: ${userRank.toLocaleString()}\n`;
                    text += `Total Colleges Found: ${data.length}\n\n`;
                    
                    data.forEach((item, index) => {
                        text += `${index + 1}. ${item.institute}\n`;
                        text += `   Branch: ${item.branch}\n`;
                        text += `   Category: ${item.category}\n`;
                        text += `   Opening Rank: ${item.opening_rank?.toLocaleString() || 'N/A'}\n`;
                        text += `   Closing Rank: ${item.closing_rank?.toLocaleString() || 'N/A'}\n`;
                        text += `   Year: ${item.year || 'N/A'}\n`;
                        text += `   Round: ${item.round || 'N/A'}\n`;
                        text += `   Quota: ${item.quota || 'N/A'}\n`;
                        text += `   Seat Type: ${item.seat_type || 'N/A'}\n\n`;
                    });
                    
                    return text;
                }

                function exportToPDF(data, filename) {
                    // Create a temporary container for PDF generation
                    const tempContainer = document.createElement('div');
                    tempContainer.style.position = 'absolute';
                    tempContainer.style.left = '-9999px';
                    tempContainer.style.top = '0';
                    tempContainer.style.width = '800px';
                    tempContainer.style.backgroundColor = 'white';
                    tempContainer.style.padding = '20px';
                    tempContainer.style.fontFamily = 'Arial, sans-serif';
                    tempContainer.style.fontSize = '12px';
                    tempContainer.style.color = 'black';
                    
                    const userRank = parseInt(rankInput.value) || 0;
                    
                    // Create PDF content
                    let html = `
                        <div style="text-align: center; margin-bottom: 20px;">
                            <h1 style="color: #2563eb; margin: 0;">WBJEE College Predictor</h1>
                            <p style="margin: 5px 0;">Generated on: ${new Date().toLocaleDateString()}</p>
                            ${userRank > 0 ? `<p style="margin: 5px 0;">Your Rank: ${userRank.toLocaleString()}</p>` : ''}
                            <p style="margin: 5px 0;">Total Colleges: ${data.length}</p>
                        </div>
                        <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
                            <thead>
                                <tr style="background-color: #f3f4f6;">
                                    <th style="border: 1px solid #d1d5db; padding: 8px; text-align: left;">Institute</th>
                                    <th style="border: 1px solid #d1d5db; padding: 8px; text-align: left;">Branch</th>
                                    <th style="border: 1px solid #d1d5db; padding: 8px; text-align: left;">Category</th>
                                    <th style="border: 1px solid #d1d5db; padding: 8px; text-align: left;">Opening Rank</th>
                                    <th style="border: 1px solid #d1d5db; padding: 8px; text-align: left;">Closing Rank</th>
                                    <th style="border: 1px solid #d1d5db; padding: 8px; text-align: left;">Year</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    data.forEach((item, index) => {
                        html += `
                            <tr style="${index % 2 === 0 ? 'background-color: #f9fafb;' : ''}">
                                <td style="border: 1px solid #d1d5db; padding: 8px;">${item.institute || 'N/A'}</td>
                                <td style="border: 1px solid #d1d5db; padding: 8px;">${item.branch || 'N/A'}</td>
                                <td style="border: 1px solid #d1d5db; padding: 8px;">${item.category || 'N/A'}</td>
                                <td style="border: 1px solid #d1d5db; padding: 8px;">${item.opening_rank?.toLocaleString() || 'N/A'}</td>
                                <td style="border: 1px solid #d1d5db; padding: 8px;">${item.closing_rank?.toLocaleString() || 'N/A'}</td>
                                <td style="border: 1px solid #d1d5db; padding: 8px;">${item.year || 'N/A'}</td>
                            </tr>
                        `;
                    });
                    
                    html += `
                            </tbody>
                        </table>
                    `;
                    
                    tempContainer.innerHTML = html;
                    document.body.appendChild(tempContainer);
                    
                    // Use html2pdf library if available, otherwise fallback to print
                    if (typeof html2pdf !== 'undefined') {
                        const opt = {
                            margin: 1,
                            filename: filename,
                            image: { type: 'jpeg', quality: 0.98 },
                            html2canvas: { scale: 2 },
                            jsPDF: { unit: 'in', format: 'a4', orientation: 'landscape' }
                        };
                        
                        html2pdf().set(opt).from(tempContainer).save().then(() => {
                            document.body.removeChild(tempContainer);
                            showModal('Success', 'PDF exported successfully!', 'success');
                        });
                    } else {
                        // Fallback to print
                        const printWindow = window.open('', '_blank');
                        printWindow.document.write(`
                            <html>
                                <head>
                                    <title>${filename.replace('.pdf', '')}</title>
                                    <style>
                                        body { font-family: Arial, sans-serif; margin: 20px; }
                                        @media print { body { margin: 0; } }
                                    </style>
                                </head>
                                <body>${html}</body>
                            </html>
                        `);
                        printWindow.document.close();
                        printWindow.print();
                        document.body.removeChild(tempContainer);
                        showModal('Info', 'Print dialog opened. You can save as PDF from there.', 'info');
                    }
                }

                // ... existing code ...
            }

            function showRankTrendChart(identifier) {
                if (rankTrendChart) {
                    rankTrendChart.destroy();
                    rankTrendChart = null;
                }
                
                const trendData = allData.filter(item => 
                    item.institute === identifier.institute &&
                    item.branch === identifier.branch &&
                    item.category === identifier.category &&
                    item.quota === identifier.quota &&
                    item.seat_type === identifier.seat_type
                ).sort((a, b) => a.year - b.year);
                const validTrendData = trendData.filter(d => d.closing_rank !== null);
                chartTitle.textContent = `Rank Trend for ${identifier.branch} at ${identifier.institute}`;
                const ctx = document.getElementById('rank-trend-chart').getContext('2d');
                if (rankTrendChart) { rankTrendChart.destroy(); }
                if (validTrendData.length < 2) {
                    ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                    ctx.font = "16px Inter, sans-serif";
                    ctx.fillStyle = "#6b7280";
                    ctx.textAlign = "center";
                    ctx.fillText("Not enough historical data to show a trend.", ctx.canvas.width / 2, 50);
                    chartModal.classList.remove('hidden');
                    return;
                }
                try {
                    rankTrendChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: validTrendData.map(d => d.year),
                            datasets: [{
                                label: 'Closing Rank',
                                data: validTrendData.map(d => d.closing_rank),
                                borderColor: 'rgba(59, 130, 246, 0.8)',
                                backgroundColor: 'rgba(59, 130, 246, 0.2)',
                                fill: true,
                                tension: 0.1
                            }]
                        },
                        options: {
                            responsive: true,
                            scales: {
                                y: { title: { display: true, text: 'Rank', color: '#374151' }, ticks: { color: '#374151' } },
                                x: { title: { display: true, text: 'Year', color: '#374151' }, ticks: { color: '#374151' } }
                            },
                            plugins: { legend: { labels: { color: '#374151' } } }
                        }
                    });
                    chartModal.classList.remove('hidden');
                } catch (error) {
                    console.error('Error creating chart:', error);
                    ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                    ctx.font = "16px Inter, sans-serif";
                    ctx.fillStyle = "#6b7280";
                    ctx.textAlign = "center";
                    ctx.fillText("Error loading chart. Please try again.", ctx.canvas.width / 2, 50);
                    chartModal.classList.remove('hidden');
                }
            }
            
            function showCollegeDetails(instituteName) {
                collegeDetailsTitle.textContent = instituteName;
                const collegeBranches = allData.filter(item => item.institute === instituteName);
                if (collegeBranches.length === 0) {
                    collegeDetailsBody.innerHTML = `<p class="text-gray-500">No data found for this college.</p>`;
                } else {
                    let html = '<div class="space-y-4">';
                    const groupedBranches = {};
                    collegeBranches.forEach(item => {
                        if (!groupedBranches[item.branch]) groupedBranches[item.branch] = [];
                        groupedBranches[item.branch].push(item);
                    });
                    const sortedBranchNames = Object.keys(groupedBranches).sort((a, b) => {
                        const bestRankA = Math.min(...groupedBranches[a].map(i => i.closing_rank || Infinity));
                        const bestRankB = Math.min(...groupedBranches[b].map(i => i.closing_rank || Infinity));
                        return bestRankA - bestRankB;
                    });
                    for (const branchName of sortedBranchNames) {
                        html += `<div class="p-3 bg-gray-100 rounded-lg">
                                    <h4 class="font-bold text-lg text-gray-800">${branchName}</h4>
                                    <ul class="mt-2 space-y-1 pl-2 border-l border-gray-300">`;
                        const sortedItems = groupedBranches[branchName].sort((a, b) => (b.year - a.year) || a.category.localeCompare(b.category));
                        sortedItems.forEach(item => {
                            html += `<li class="text-sm text-gray-600">
                                <strong>${item.year}:</strong> ${item.category} (${item.quota}) - 
                                <strong>Closing Rank:</strong> <span class="font-mono">${item.closing_rank ?? 'N/A'}</span>
                            </li>`;
                        });
                        html += `</ul></div>`;
                    }
                    html += `</div>`;
                    collegeDetailsBody.innerHTML = html;
                }
                collegeDetailsModal.classList.remove('hidden');
            }
            
            function showComparison(selectedIds) {
                comparisonBody.innerHTML = '';
                comparisonCharts.forEach(chart => chart.destroy());
                comparisonCharts = [];
                selectedIds.forEach((id, index) => {
                    const item = allData.find(d => d.id === id);
                    if (!item) return;
                    const trendData = allData.filter(d => 
                        d.institute === item.institute && d.branch === item.branch && d.category === item.category && d.quota === item.quota && d.seat_type === item.seat_type
                    ).sort((a, b) => a.year - b.year || a.round - b.round);
                    const ranks = trendData.map(d => d.closing_rank).filter(r => r !== null);
                    const years = trendData.map(d => d.year).filter((_, i) => trendData[i].closing_rank !== null);
                    const avgRank = ranks.length ? Math.round(ranks.reduce((a, b) => a + b, 0) / ranks.length) : 'N/A';
                    const bestRank = ranks.length ? Math.min(...ranks) : 'N/A';
                    // Recent Rank (most recent year/round)
                    let recentRank = 'N/A', recentYear = '', recentRound = '';
                    if (trendData.length) {
                        const mostRecent = trendData.reduce((a, b) => {
                            if (b.year > a.year) return b;
                            if (b.year === a.year && b.round > a.round) return b;
                            return a;
                        }, trendData[0]);
                        recentRank = mostRecent.closing_rank ?? 'N/A';
                        recentYear = mostRecent.year;
                        recentRound = mostRecent.round;
                    }
                    // Linear Regression Slope Trend
                    function calculateTrendSlope(years, ranks) {
                        const n = years.length;
                        if (n < 2) return 0;
                        const meanX = years.reduce((a, b) => a + b, 0) / n;
                        const meanY = ranks.reduce((a, b) => a + b, 0) / n;
                        let num = 0, den = 0;
                        for (let i = 0; i < n; i++) {
                            num += (years[i] - meanX) * (ranks[i] - meanY);
                            den += (years[i] - meanX) ** 2;
                        }
                        return den === 0 ? 0 : num / den;
                    }
                    const slope = calculateTrendSlope(years, ranks);
                    let trend = { text: 'Stable', color: 'text-gray-500' };
                    if (slope < -10) trend = { text: 'Getting More Competitive ', color: 'text-green-500' };
                    else if (slope > 10) trend = { text: 'Getting Less Competitive ', color: 'text-red-500' };
                    // END Linear Regression Slope Trend
                    const column = document.createElement('div');
                    column.className = 'bg-gray-100 p-4 rounded-lg';
                    column.innerHTML = `
                        <h4 class="font-bold text-lg text-gray-900">${item.institute}</h4>
                        <p class="text-blue-600 mb-4">${item.branch}</p>
                        <canvas id="compare-chart-${index}"></canvas>
                        <div class="mt-4 space-y-2 text-sm">
                            <p><strong>Category:</strong> ${item.category}</p>
                            <p><strong>Recent Rank (${recentYear}${recentRound ? ', Round ' + recentRound : ''}):</strong> ${recentRank}</p>
                            <p><strong>Avg. Rank:</strong> ${avgRank}</p>
                            <p><strong>Best Rank:</strong> ${bestRank}</p>
                            <p><strong>Trend:</strong> <span class="${trend.color}">${trend.text}</span></p>
                        </div>`;
                    comparisonBody.appendChild(column);
                    const ctx = document.getElementById(`compare-chart-${index}`).getContext('2d');
                    try {
                        const newChart = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: trendData.map(d => d.year),
                                datasets: [{ label: 'Closing Rank', data: trendData.map(d => d.closing_rank), borderColor: 'rgba(79, 70, 229, 0.8)', tension: 0.1 }]
                            },
                            options: { scales: { y: { ticks: { color: '#374151' } }, x: { ticks: { color: '#374151' } } }, plugins: { legend: { display: false } } }
                        });
                        comparisonCharts.push(newChart);
                    } catch (error) {
                        console.error('Error creating comparison chart:', error);
                        ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                        ctx.font = "14px Inter, sans-serif";
                        ctx.fillStyle = "#6b7280";
                        ctx.textAlign = "center";
                        ctx.fillText("Chart unavailable", ctx.canvas.width / 2, 30);
                    }
                });
                comparisonModal.classList.remove('hidden');
            }

            function exportToCSV() {
                const headers = ["Institute", "Branch", "Category", "Quota", "Seat Type", "Opening Rank", "Closing Rank", "Year", "Round"];
                const rows = filteredData.map(item => [
                    `"${item.institute || ''}"`,`"${item.branch || ''}"`,`"${item.category || ''}"`,`"${item.quota || ''}"`,`"${item.seat_type || ''}"`,
                    item.opening_rank ?? '', item.closing_rank ?? '', item.year ?? '', `"${item.round || ''}"`
                ]);
                let csvContent = "data:text/csv;charset=utf-8," + headers.join(",") + "\n" + rows.map(e => e.join(",")).join("\n");
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "wbjee_predictor_data.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            function exportShortlistToCSV(shortlistData) {
                const headers = ["Institute", "Branch", "Category", "Quota", "Seat Type", "Opening Rank", "Closing Rank", "Year", "Round"];
                const rows = shortlistData.map(item => [
                    `"${item.institute || ''}"`,`"${item.branch || ''}"`,`"${item.category || ''}"`,`"${item.quota || ''}"`,`"${item.seat_type || ''}"`,
                    item.opening_rank ?? '', item.closing_rank ?? '', item.year ?? '', `"${item.round || ''}"`
                ]);
                let csvContent = "data:text/csv;charset=utf-8," + headers.join(",") + "\n" + rows.map(e => e.join(",")).join("\n");
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "wbjee_shortlist.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
            
            function showInputErrorModal() {
                const modal = document.getElementById('input-error-modal');
                const message = document.getElementById('input-error-message');

                message.textContent = 'Please enter your WBJEE rank.';
                modal.classList.remove('hidden');
            }

            function updateFavoriteColumn() {
              if (document.querySelector('.favorite-btn:hover')) return;
              
              document.querySelectorAll('#table-body tr').forEach(row => {
                const favBtn = row.querySelector('.favorite-btn');
                if (!favBtn) return;
                
                const identifier = JSON.parse(row.dataset.identifier);
                const item = allData.find(d =>
                  d.institute === identifier.institute &&
                  d.branch === identifier.branch &&
                  d.category === identifier.category &&
                  d.quota === identifier.quota &&
                  d.seat_type === identifier.seat_type
                );
                if (!item) return;
                
                const id = item.id;
                const shouldBeFavorited = favorites.has(id);
                const isCurrentlyFavorited = favBtn.classList.contains('favorited');
                
                if (shouldBeFavorited && !isCurrentlyFavorited) {
                  favBtn.classList.add('favorited');
                } else if (!shouldBeFavorited && isCurrentlyFavorited) {
                  favBtn.classList.remove('favorited');
                }
              });
            }
            
            function showModal(title, message, type = 'info') {
                const modal = document.getElementById('general-modal');
                const modalContent = document.getElementById('modal-content');
                const modalTitle = document.getElementById('modal-title');
                const modalMessage = document.getElementById('modal-message');
                
                let icon = '';
                if (type === 'error') icon = '';
                if (type === 'warning') icon = '';
                if (type === 'success') icon = '';
                
                modalTitle.innerHTML = `${icon} ${title}`;
                modalMessage.textContent = message;
                
                modal.classList.remove('hidden');
                
                setTimeout(() => {
                    modalContent.classList.remove('scale-95', 'opacity-0');
                    modalContent.classList.add('scale-100', 'opacity-100');
                }, 10);
                
                modal.focus();
            }
            
            function hideModal() {
                const modal = document.getElementById('general-modal');
                const modalContent = document.getElementById('modal-content');
                
                modalContent.classList.remove('scale-100', 'opacity-100');
                modalContent.classList.add('scale-95', 'opacity-0');
                
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 300);
            }
            
            function initModalSystem() {
                const modal = document.getElementById('general-modal');
                const closeBtn = document.getElementById('close-general-modal');
                const okBtn = document.getElementById('modal-ok-btn');
                
                closeBtn.addEventListener('click', hideModal);
                
                okBtn.addEventListener('click', hideModal);
                
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        hideModal();
                    }
                });
                
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
                        hideModal();
                    }
                });
            }
            


            function getPredictionBadge(prediction) {
                const badgeClasses = {
                    'Confirm': 'bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-100 border-green-300 dark:border-green-700',
                    'Great': 'bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-100 border-blue-300 dark:border-blue-700',
                    'Good': 'bg-cyan-100 dark:bg-cyan-900/30 text-cyan-800 dark:text-cyan-100 border-cyan-300 dark:border-cyan-700',
                    'Low': 'bg-amber-100 dark:bg-amber-900/30 text-amber-800 dark:text-amber-100 border-amber-300 dark:border-amber-700',
                    'No Chance': 'bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-100 border-red-300 dark:border-red-700'
                };
                
                const badgeClass = badgeClasses[prediction.text] || 'bg-gray-100 dark:bg-gray-900/30 text-gray-800 dark:text-gray-100 border-gray-300 dark:border-gray-700';
                
                return `<span class="px-3 py-1.5 rounded-lg border-2 font-semibold text-sm shadow-sm ${badgeClass}">${prediction.text}</span>`;
            }

            initializeApp();
        }
        
                    document.addEventListener('DOMContentLoaded', () => {
            if (window.cssLoaded) {
                initializeApp();
            } else {
                const checkCSS = setInterval(() => {
                    if (window.cssLoaded) {
                        clearInterval(checkCSS);
                        initializeApp();
                    }
                }, 10);
            }
        });
    </script>

    <section class="bg-white border-t border-gray-200 mt-12 py-8">
      <div class="container mx-auto px-4 md:px-8">
        <button id="toggle-faq-section" class="mx-auto block mb-4 px-4 py-2 text-sm text-gray-700 bg-gray-100 rounded hover:bg-gray-200 border border-gray-300" style="outline: none !important; box-shadow: none !important;" aria-expanded="false">
          Show FAQ
        </button>
        <div id="faq-section-content" class="max-w-4xl mx-auto space-y-4" style="display: none;">
          <h2 class="text-xl font-semibold text-gray-800 mb-4 text-center">Frequently Asked Questions</h2>
          <div id="faq-accordion">
            <div class="border-b">
              <button class="w-full text-left p-3 font-medium text-gray-900 flex justify-between items-center" style="outline: none !important; box-shadow: none !important;" onclick="toggleFaq(0)">
                <span>How to use WBJEE College Finder?</span>
                <span id="faq-arrow-0"></span>
              </button>
              <div class="faq-answer px-4 pb-3 text-gray-700 hidden">
                Enter your WBJEE rank in the input field and click search. The tool will show you colleges and branches where you have a good chance of admission based on historical cutoff data from official WBJEE sources.
              </div>
            </div>
            <div class="border-b">
              <button class="w-full text-left p-3 font-medium text-gray-900 flex justify-between items-center" style="outline: none !important; box-shadow: none !important;" onclick="toggleFaq(1)">
                <span>Is this WBJEE college predictor free?</span>
                <span id="faq-arrow-1"></span>
              </button>
              <div class="faq-answer px-4 pb-3 text-gray-700 hidden">
                Yes, this WBJEE college finder tool is completely free to use. No registration, payment, or subscription required. We believe in making college prediction accessible to all WBJEE aspirants.
              </div>
            </div>
            <div class="border-b">
              <button class="w-full text-left p-3 font-medium text-gray-900 flex justify-between items-center" style="outline: none !important; box-shadow: none !important;" onclick="toggleFaq(2)">
                <span>How accurate is the WBJEE college prediction?</span>
                <span id="faq-arrow-2"></span>
              </button>
              <div class="faq-answer px-4 pb-3 text-gray-700 hidden">
                The predictions are based on historical WBJEE cutoff data from official sources. While we strive for accuracy, actual cutoffs may vary each year depending on factors like exam difficulty, number of applicants, and seat availability.
              </div>
            </div>
            <div class="border-b">
              <button class="w-full text-left p-3 font-medium text-gray-900 flex justify-between items-center" style="outline: none !important; box-shadow: none !important;" onclick="toggleFaq(3)">
                <span>Which colleges are included in WBJEE College Finder?</span>
                <span id="faq-arrow-3"></span>
              </button>
              <div class="faq-answer px-4 pb-3 text-gray-700 hidden">
                The tool includes all engineering colleges in West Bengal that participate in WBJEE counseling, including government institutions like Jadavpur University, Calcutta University, and private engineering colleges across the state.
              </div>
            </div>
            <div class="border-b">
              <button class="w-full text-left p-3 font-medium text-gray-900 flex justify-between items-center" style="outline: none !important; box-shadow: none !important;" onclick="toggleFaq(4)">
                <span>What do the prediction colors mean?</span>
                <span id="faq-arrow-4"></span>
              </button>
              <div class="faq-answer px-4 pb-3 text-gray-700 hidden">
                Green (Confirm): High chance of admission. Blue (Great): Very good chance. Cyan (Good): Good chance. Yellow (Low): Low chance. Red (No Chance): Very low chance based on historical data.
              </div>
            </div>
            <div class="border-b">
              <button class="w-full text-left p-3 font-medium text-gray-900 flex justify-between items-center" style="outline: none !important; box-shadow: none !important;" onclick="toggleFaq(5)">
                <span>Can I export my results?</span>
                <span id="faq-arrow-5"></span>
              </button>
              <div class="faq-answer px-4 pb-3 text-gray-700 hidden">
                Yes! You can export your filtered results or shortlist to CSV format for offline reference. Use the "Export" buttons to download your data.
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
    <script>
    function toggleFaq(idx) {
      const answers = document.querySelectorAll('#faq-accordion .faq-answer');
      const arrows = document.querySelectorAll('#faq-accordion [id^="faq-arrow-"]');
      answers.forEach((ans, i) => {
        if (i === idx) {
          const isOpen = !ans.classList.contains('hidden');
          ans.classList.toggle('hidden');
          arrows[i].textContent = isOpen ? '' : '';
        } else {
          ans.classList.add('hidden');
          arrows[i].textContent = '';
        }
      });
    }
    const faqSectionContent = document.getElementById('faq-section-content');
    const toggleFaqSectionBtn = document.getElementById('toggle-faq-section');
    toggleFaqSectionBtn.addEventListener('click', function() {
      const isOpen = faqSectionContent.style.display === 'block';
      faqSectionContent.style.display = isOpen ? 'none' : 'block';
                      toggleFaqSectionBtn.innerHTML = `<span class="text-gray-700 dark:text-gray-300">${isOpen ? 'Show FAQ' : 'Hide FAQ'}</span>`;
      toggleFaqSectionBtn.setAttribute('aria-expanded', !isOpen);
    });
    </script>

    <button id="back-to-top" class="back-to-top bg-[#53AC5D] hover:bg-[#4a9c52] text-white p-3 rounded-full shadow-lg transition-all duration-300" style="background-color: #53AC5D !important; outline: none !important; box-shadow: none !important;" aria-label="Back to top">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18" />
        </svg>
    </button>

    <footer class="bg-gray-50 dark:bg-gray-900 border-t border-gray-200 dark:border-gray-700 mt-12 py-8">
            <div class="max-w-7xl mx-auto px-4">
        <div class="mb-6 flex flex-wrap justify-center gap-3">
          <span class="px-4 py-2 rounded-full text-sm font-medium" style="background-color: #f0fdf4; color: #166534; border: 2px solid #bbf7d0;">
            Free to use
          </span>
          <span class="px-4 py-2 rounded-full text-sm font-medium" style="background-color: #eff6ff; color: #1e40af; border: 2px solid #bfdbfe;">
            Official data
          </span>
          <span class="px-4 py-2 rounded-full text-sm font-medium" style="background-color: #faf5ff; color: #7c3aed; border: 2px solid #ddd6fe;">
            Mobile friendly
          </span>
          <span class="px-4 py-2 rounded-full text-sm font-medium" style="background-color: #fefce8; color: #a16207; border: 2px solid #fef08a;">
            Instant results
          </span>
        </div>

        <div class="text-center space-y-4">
          <div id="last-updated" class="text-xs font-medium text-gray-700 dark:text-gray-100"></div>
          
          <div class="text-sm font-medium text-gray-800 dark:text-gray-100">
            &copy; <span id="current-year"></span> WBJEE College Predictor. Not affiliated with WBJEEB.
          </div>
          
          <div class="flex flex-wrap justify-center items-center gap-6 text-sm">
            <div class="flex items-center gap-1">
              <svg class="w-4 h-4 text-gray-500 dark:text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path>
              </svg>
              <span class="text-gray-700 dark:text-gray-300">Created by</span> 
              <a href="https://www.reddit.com/user/rizzz6" class="text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 hover:underline font-medium transition-colors" target="_blank" rel="noopener">u/rizzz6</a>
            </div>
            
            <div class="flex items-center gap-1">
              <svg class="w-4 h-4 text-gray-500 dark:text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                <path d="M2 5a2 2 0 012-2h7a2 2 0 012 2v4a2 2 0 01-2 2H9l-3 3v-3H4a2 2 0 01-2-2V5z"></path>
                <path d="M15 7v2a4 4 0 01-4 4H9.828l-1.766 1.767c-.28.28-.732.28-1.012 0L5 13.828V12a4 4 0 014-4h6z"></path>
              </svg>
              <span class="text-gray-700 dark:text-gray-300">Join our community,</span> 
              <a href="https://www.reddit.com/r/wbjee" class="text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 hover:underline font-medium transition-colors" target="_blank" rel="noopener">r/wbjee</a>
            </div>
            
            <div class="flex items-center gap-1">
              <svg class="w-4 h-4 text-gray-500 dark:text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10a2 2 0 00-2-2H4zm2 6a2 2 0 012-2h8a2 2 0 012 2v4a2 2 0 01-2 2H8a2 2 0 01-2-2v-4zm6 4a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path>
              </svg>
              <span class="text-gray-700 dark:text-gray-300">Data source:</span> 
              <a href="https://wbjeeb.nic.in" class="text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 hover:underline font-medium transition-colors" target="_blank" rel="noopener">WBJEEB official site</a>
            </div>
            
            <div class="flex items-center gap-1">
              <svg class="w-4 h-4 text-gray-500 dark:text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z" clip-rule="evenodd"></path>
              </svg>
              <a href="#" onclick="showModal('help-modal'); return false;" class="text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 hover:underline font-medium transition-colors">Help & FAQ</a>
            </div>
            
            <div class="flex items-center gap-1">
              <svg class="w-4 h-4 text-gray-500 dark:text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
              </svg>
              <a href="#" onclick="showModal('legend-modal'); return false;" class="text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 hover:underline font-medium transition-colors">Legend</a>
            </div>
            
            <div class="flex items-center gap-1">
              <svg class="w-4 h-4 text-gray-500 dark:text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
              </svg>
              <a href="#" onclick="window.scrollTo({top: 0, behavior: 'smooth'}); return false;" class="text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 hover:underline font-medium transition-colors">Back to Top</a>
            </div>
          </div>
        </div>
      </div>
    </footer>
    <script>
      const lastUpdated = new Date();
      const options = { year: 'numeric', month: 'long', day: 'numeric' };
      document.getElementById('last-updated').textContent =
        'Last updated: ' + lastUpdated.toLocaleDateString(undefined, options);
      
      document.getElementById('current-year').textContent = new Date().getFullYear();
    </script>

    <script>
    document.querySelectorAll('#faq-accordion button[onclick^="toggleFaq"]').forEach((btn, idx) => {
      btn.setAttribute('tabindex', '0');
      btn.setAttribute('role', 'button');
      btn.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          toggleFaq(idx);
        }
      });
    });



    </script>


</body>
</html>
